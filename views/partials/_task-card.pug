// src/views/partials/_task-card.pug
// è©² Mixin åŒ…å«äº†æ™ºæ…§ Close æŒ‰éˆ•é‚è¼¯å’Œæ‰€æœ‰ç‹€æ…‹çš„å‹•ä½œã€‚

// ä»»å‹™å¡ç‰‡ Mixin
// æ¥æ”¶åƒæ•¸ï¼š
// - task: ä»»å‹™ç‰©ä»¶ï¼ŒåŒ…å« canClose å±¬æ€§ (ç”± service æ³¨å…¥)
// - csrfToken: ç”¨æ–¼è¡¨å–®æäº¤
// - cardClassForPrio: è™•ç†å„ªå…ˆç´šæ¨£å¼çš„ helper å‡½å¼
mixin taskCard(task, csrfToken, cardClassForPrio)
  -
    // Helper å‡½å¼ï¼Œç”¨æ–¼åˆ¤æ–·ç‹€æ…‹
    const isOpen = (t) => t.status === 'OPEN';
    const isClosed = (t) => t.status === 'CLOSED';
    const isArchived = (t) => t.status === 'ARCHIVED';

  .col-12.col-md-6
    .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // å³ä¸Šè§’å‹•ä½œå€åŸŸ
      .position-absolute.top-0.end-0.m-2
        // 1. è™•ç† OPEN ç‹€æ…‹ä¸‹çš„å‹•ä½œ (Close / SubTasks Open)
        if isOpen(task)
          // ğŸš¨ æ™ºæ…§ Close æŒ‰éˆ•é‚è¼¯ï¼šåªæœ‰åœ¨ canClose ç‚º true æ™‚æ‰é¡¯ç¤º Close æŒ‰éˆ•
          if task.canClose
            form(action=`/api/tasks/${task.id}/close`, method="POST")
              if typeof csrfToken !== 'undefined'
                input(type="hidden", name="_csrf", value=csrfToken)
              input(type="hidden", name="status", value="CLOSED")
              button.btn.btn-success.btn-sm(type="submit" title="Close this task")
                i.bi.bi-check2-circle.me-1
                | Close
          else
            // ä»»å‹™é–‹æ”¾ï¼Œä½†ä¸èƒ½é—œé–‰ (å› ç‚ºæœ‰ SubTask æœªå®Œæˆ)
            button.btn.btn-outline-secondary.btn-sm(type="button" disabled title="Requires SubTasks completion")
              i.bi.bi-info-circle.me-1
              | SubTasks Open
        
        else if isClosed(task)
          .btn-group
            // Archive
            form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="me-1 d-inline")
              if typeof csrfToken !== 'undefined'
                input(type="hidden", name="_csrf", value=csrfToken)
              input(type="hidden", name="status", value="ARCHIVED")
              button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive")
                i.bi.bi-box-arrow-down.me-1
                | Archive
            // Reopen
            form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="d-inline")
              if typeof csrfToken !== 'undefined'
                input(type="hidden", name="_csrf", value=csrfToken)
              input(type="hidden", name="status", value="OPEN")
              button.btn.btn-outline-primary.btn-sm(type="submit" title="Reopen")
                i.bi.bi-arrow-counterclockwise.me-1
                | Reopen
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // å¡ç‰‡ä¸»é«”å…§å®¹
      .card-body
        // ç‹€æ…‹å¾½ç« 
        if isArchived(task)
          span.badge.text-bg-secondary.float-end Archived
        else if isClosed(task)
          span.badge.text-bg-success.float-end Closed

        h3.h6.card-title.mb-1
          a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'

        // æˆªæ­¢æ™‚é–“
        if task.allDay
          if task.dueLabel
            small.text-muted.d-block All-day: #{task.dueLabel}
        else
          if task.dueLabel
            small.text-muted.d-block Due: #{task.dueLabel}

        // é¡å¤–è³‡è¨Š (Location / Description)
        .row.mt-2.gx-2
          .col-6
            if task.location
              small.text-muted.d-block.text-truncate ğŸ“ #{task.location}
          .col-6
            if task.description
              small.text-muted.d-block.text-truncate(title=task.description) âœ’ï¸ #{task.description}
        
        // æŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
        .mt-3
          a.btn.btn-sm.btn-outline-primary(href=`/tasks/${task.id}`) View Details