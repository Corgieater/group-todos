doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Group Tasks â€“ #{groupName || 'Group'}
    include ../partials/bootstrap

    style.
      .card .card-body { padding: 0.875rem 1rem; }
      .badge-assignee-initial {
        width: 28px; height: 28px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%; border: 1px solid var(--bs-border-color,#dee2e6);
        font-weight: 600;
      }

  body
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p]||''} ${prioBorderMap[p]||'border-secondary'} border-2`;

        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;
        const total = safeLen(expired) + safeLen(today) + safeLen(none);

        const isOpen = (t) => t.status === 'OPEN';
        const isClosed = (t) => t.status === 'CLOSED';
        const isArchived = (t) => t.status === 'ARCHIVED';

        const ADMINISH = new Set(['OWNER','ADMIN']);
        const isAdminishViewer = ADMINISH.has(viewerRole);
        const canManage = (t) => (isAdminishViewer || t.ownerId === viewerId);

        const forceModalId = (t) => `forceCloseModal-${t.id}`;

      // Header
      .row.mb-3
        .col
          h1.h4.mb-1 #{groupName || 'Group'} Tasks
          small.text-muted Group ID: #{groupId}
        .col-auto.text-end
          span.badge.bg-primary-subtle.text-primary-emphasis.me-2 #{total}
          | tasks

      .mb-3
        a.btn.btn-sm.btn-outline-primary(href=`/groups/${groupId}/tasks/create`)
          i.bi.bi-plus-lg.me-1
          | New Task

      // ===== mixin =====
      mixin taskCard(task)
        -
          const hasAssignees = typeof task.hasAssignees !== 'undefined'
            ? !!task.hasAssignees
            : (Array.isArray(task.assignees) && task.assignees.length > 0);

          const totalAssignees = hasAssignees ? task.assignees.length : 0;
          const completedCount = hasAssignees
            ? task.assignees.filter(a => a.status === 'COMPLETED').length
            : 0;

          const noneCompleted = !hasAssignees || completedCount === 0;
          const allCompleted  = hasAssignees && completedCount === totalAssignees;
          const someCompleted = hasAssignees && completedCount > 0 && completedCount < totalAssignees;

          const first = hasAssignees ? task.assignees[0] : null;
          const firstName = first && (first.name || first.email || '');
          const initial = firstName ? String(firstName).trim().charAt(0).toUpperCase() : null;
          const extraCount = hasAssignees ? Math.max(0, task.assignees.length - 1) : 0;

        .card.h-100.shadow-sm(class=cardClassForPrio(task.priority))
          .card-body
            .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.gap-2
              .d-flex.align-items-center.gap-2.flex-grow-1.min-w-0
                if initial
                  span.badge-assignee-initial= initial
                h3.h6.card-title.mb-0.text-truncate
                  a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                if extraCount > 0
                  span.badge.rounded-pill.text-bg-secondary.ms-1(title=`+${extraCount} more assignees`)= `+${extraCount}`

              if canManage(task)
                .d-flex.flex-column.flex-md-row.gap-2
                  if isOpen(task)
                    // å…ˆåˆ†æˆã€Œ0äººå®Œæˆã€å’Œã€Œå…¶ä»–ã€å…©å¡Šï¼Œé¿å… else if è¢«è¨»è§£åˆ‡é–‹
                    if noneCompleted
                      // 0äººå®Œæˆ â†’ åªèƒ½ Archive
                      form(action=`/api/tasks/${task.id}/archive`, method="POST", class="d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="ARCHIVED")
                        button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive (no assignees completed)")
                          i.bi.bi-box-arrow-down.me-1
                          | Archive
                    else
                      // é€™è£¡å°±åªå‰©å…©ç¨®å¯èƒ½ï¼šå…¨éƒ¨å®Œæˆ / éƒ¨åˆ†å®Œæˆ
                      if allCompleted
                        form(action=`/api/tasks/${task.id}/close`, method="POST", class="d-inline")
                          if typeof csrfToken !== 'undefined'
                            input(type="hidden", name="_csrf", value=csrfToken)
                          button.btn.btn-success.btn-sm(type="submit" title="Close (all assignees completed)")
                            i.bi.bi-check2-circle.me-1
                            | Close
                      else if someCompleted && isAdminishViewer
                        button.btn.btn-outline-danger.btn-sm(
                          type="button"
                          title="Force close with reason"
                          data-bs-toggle="modal"
                          data-bs-target=`#${forceModalId(task)}`
                        )
                          i.bi.bi-exclamation-triangle.me-1
                          | Force Close
                  else if isClosed(task)
                    form(action=`/api/tasks/${task.id}/archive`, method="POST", class="d-inline")
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden", name="_csrf", value=csrfToken)
                      input(type="hidden", name="status", value="ARCHIVED")
                      button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive")
                        i.bi.bi-box-arrow-down.me-1
                        | Archive
                    form(action=`/api/tasks/${task.id}/restore`, method="POST", class="d-inline")
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden", name="_csrf", value=csrfToken)
                      input(type="hidden", name="status", value="OPEN")
                      button.btn.btn-outline-primary.btn-sm(type="submit" title="Reopen")
                        i.bi.bi-arrow-counterclockwise.me-1
                        | Reopen

            .d-flex.align-items-center.gap-2.mt-2
              if isArchived(task)
                span.badge.text-bg-secondary Archived
              else if isClosed(task)
                span.badge.text-bg-success Closed
              else if hasAssignees && firstName
                small.text-muted.text-truncate(title=firstName)= `Assignee: ${firstName}`

            .row.mt-2.gx-2
              .col-12.col-md-6
                if task.allDay && task.dueLabel
                  small.text-muted.d-block All-day: #{task.dueLabel}
                else if task.dueLabel
                  small.text-muted.d-block Due: #{task.dueLabel}
              .col-12.col-md-6
                if task.location
                  small.text-muted.d-block.text-truncate ğŸ“ #{task.location}
                if task.description
                  small.text-muted.d-block.text-truncate(title=task.description) âœ’ï¸ #{task.description}

            if !canManage(task)
              .mt-2
                a.btn.btn-sm.btn-outline-secondary(href=`/tasks/${task.id}` title="Open details to request changes")
                  i.bi.bi-box-arrow-up-right.me-1
                  | View details

          // Force Close Modalï¼šåªæœ‰ã€Œéƒ¨åˆ†å®Œæˆã€ä¸” adminish æ™‚æ‰ç•«
          if someCompleted && isAdminishViewer
            .modal.fade(id=forceModalId(task) tabindex="-1" aria-labelledby=`${forceModalId(task)}-label` aria-hidden="true")
              .modal-dialog
                .modal-content
                  .modal-header
                    h5.modal-title(id=`${forceModalId(task)}-label`) Force Close Task
                    button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
                  form(action=`/api/tasks/${task.id}/close`, method="POST")
                    if typeof csrfToken !== 'undefined'
                      input(type="hidden", name="_csrf", value=csrfToken)
                    input(type="hidden", name="force", value="1")
                    .modal-body
                      p.mb-2 This will close the task even though some assignees did not complete.
                      .mb-3
                        label.form-label(for=`${forceModalId(task)}-reason`) Reason (required)
                        textarea.form-control(id=`${forceModalId(task)}-reason` name="closedReason" rows="3" required placeholder="e.g. out of scope / duplicated / emergency")
                    .modal-footer
                      button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                      button.btn.btn-danger(type="submit") Force Close

      // =============== Expired ===============
      section.mt-2
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Expired
          if safeLen(expired)
            span.badge.text-bg-danger #{expired.length}
        if expired && expired.length
          .row.g-3
            each task in expired
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic No expired tasks.

      // =============== Today ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Today
          if safeLen(today)
            span.badge.text-bg-info #{today.length}
        if today && today.length
          .row.g-3
            each task in today
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic Nothing scheduled for today.

      // =============== No due date ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 No due date
          if safeLen(none)
            span.badge.text-bg-secondary #{none.length}
        if none && none.length
          .row.g-3
            each task in none
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic Nothing without due date.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
