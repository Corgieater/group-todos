doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Group Tasks ‚Äì #{groupName || 'Group'}
    include ../partials/bootstrap
  body
    // partials
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        // Priority Ê®£ÂºèÂ∞çÊáâ
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p]||''} ${prioBorderMap[p]||'border-secondary'} border-2`;

        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;

      // Header
      .row.mb-3
        .col
          h1.h4.mb-1 #{groupName || 'Group'} Tasks
          p.text-muted.mb-0 Group ID: #{groupId}
        .col-auto.text-end
          //- ÂêàË®àÂè™ÁÆó‰∏âÂÄã bucket
          -
            const total = safeLen(expired) + safeLen(today) + safeLen(none);
          span.badge.bg-primary-subtle.text-primary-emphasis.me-2 #{total}
          | tasks

      // Âø´ÈÄüÊìç‰ΩúÔºàÂèØ‰æùÈúÄË¶ÅË™øÊï¥Ôºâ
      .mb-3
        a.btn.btn-sm.btn-outline-primary(href=`/groups/${groupId}/tasks/new`)
          i.bi.bi-plus-lg.me-1
          | New Task

      // =============== Expired ===============
      section.mt-2
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Expired
          if safeLen(expired)
            span.badge.text-bg-danger #{expired.length}
        if expired && expired.length
          .row.g-3
            each task in expired
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  if task.status !== 'FINISHED'
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/update/status`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden" name="_csrf" value=csrfToken)
                      input(type="hidden" name="status" value="FINISHED")
                      button.btn.btn-success.btn-sm(type="submit" title="Mark as finished")
                        i.bi.bi-check2-circle.me-1
                        | Done
                  .card-body
                    h3.h6.card-title.mb-1
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                    // ÊôÇÈñìÈ°ØÁ§∫
                    if task.allDay
                      if task.dueLabel
                        small.text-muted.d-block All-day: #{task.dueLabel}
                    else
                      if task.dueLabel
                        small.text-muted.d-block Due: #{task.dueLabel}
                    .row.mt-2.gx-2
                      .col-6
                        if task.location
                          small.text-muted.d-block.text-truncate üìç #{task.location}
                      .col-6
                        if task.description
                          small.text-muted.d-block.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
        else
          p.text-muted.fst-italic No expired tasks.

      // =============== Today ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Today
          if safeLen(today)
            span.badge.text-bg-info #{today.length}
        if today && today.length
          .row.g-3
            each task in today
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  if task.status !== 'FINISHED'
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/update/status`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden" name="_csrf" value=csrfToken)
                      input(type="hidden" name="status" value="FINISHED")
                      button.btn.btn-success.btn-sm(type="submit" title="Mark as finished")
                        i.bi.bi-check2-circle.me-1
                        | Done
                  .card-body
                    h3.h6.card-title.mb-1
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                    if task.allDay
                      if task.dueLabel
                        small.text-muted.d-block All-day: #{task.dueLabel}
                    else
                      if task.dueLabel
                        small.text-muted.d-block Due: #{task.dueLabel}
                    .row.mt-2.gx-2
                      .col-6
                        if task.location
                          small.text-muted.d-block.text-truncate üìç #{task.location}
                      .col-6
                        if task.description
                          small.text-muted.d-block.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
        else
          p.text-muted.fst-italic Nothing scheduled for today.

      // =============== No due date ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 No due date
          if safeLen(none)
            span.badge.text-bg-secondary #{none.length}
        if none && none.length
          .row.g-3
            each task in none
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  if task.status !== 'FINISHED'
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/update/status`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden" name="_csrf" value=csrfToken)
                      input(type="hidden" name="status" value="FINISHED")
                      button.btn.btn-success.btn-sm(type="submit" title="Mark as finished")
                        i.bi.bi-check2-circle.me-1
                        | Done
                  .card-body
                    h3.h6.card-title.mb-1
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                    if task.description
                      p.mb-0.small.text-muted.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
                    if task.location
                      small.text-muted.d-block.mt-1.text-truncate üìç #{task.location}
        else
          p.text-muted.fst-italic Nothing without due date.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
