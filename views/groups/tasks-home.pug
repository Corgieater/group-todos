doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Group Tasks â€“ #{groupName || 'Group'}
    include ../partials/bootstrap

    style.
      .card .card-body { padding: 0.875rem 1rem; }
      .badge-assignee-initial {
        width: 28px; height: 28px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%; border: 1px solid var(--bs-border-color,#dee2e6);
        font-weight: 600;
        background-color: var(--bs-tertiary-bg);
      }

  body
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p]||''} ${prioBorderMap[p]||'border-secondary'} border-2`;

        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;
        const total = safeLen(expired) + safeLen(today) + safeLen(none);

        const ADMINISH = new Set(['OWNER','ADMIN']);
        const isAdminishViewer = ADMINISH.has(viewerRole);
        const canManage = (t) => (isAdminishViewer || t.ownerId === viewerId);
        
        // é è¨­é™åˆ¶ (å°æ‡‰ Controller)
        const VIEW_LIMITS = { EXPIRED: 5, TODAY: 15, NONE: 10 };

      // Header
      .row.mb-4.align-items-center
        .col
          h1.h4.mb-1 #{groupName || 'Group'} Tasks
          small.text-muted ðŸ‘¥ Role: #{viewerRole.role}
        .col-auto.text-end
          a.btn.btn-primary(href=`/groups/${groupId}/tasks/create`)
            i.bi.bi-plus-lg.me-1
            | New Task

      // ===== mixin =====
      mixin taskCard(task)
        -
          const first = task.assignees && task.assignees[0];
          const firstName = first && (first.name || first.email || '');
          const initial = firstName ? String(firstName).trim().charAt(0).toUpperCase() : null;
          const extraCount = Math.max(0, (task.assignees?.length || 0) - 1);

        .card.h-100.shadow-sm(class=cardClassForPrio(task.priority))
          .card-body
            .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.gap-2
              .d-flex.align-items-center.gap-2.flex-grow-1.min-w-0
                if initial
                  span.badge-assignee-initial(title=firstName)= initial
                h3.h6.card-title.mb-0.text-truncate
                  a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                if extraCount > 0
                  span.badge.rounded-pill.text-bg-secondary.ms-1(title=`+${extraCount} more assignees`)= `+${extraCount}`

              if canManage(task)
                .d-flex.gap-2
                  if task.status === 'OPEN'
                    button.btn.btn-success.btn-sm.btn-mark-done(
                      type="button"
                      data-id=task.id
                      data-csrf=csrfToken
                      data-can-close=(task.canClose ? "true" : "false")
                    )
                      i.bi.bi-check2-circle.me-1
                      | Done
                  
                  a.btn.btn-outline-primary.btn-sm(href=`/tasks/${task.id}/edit`)
                    i.bi.bi-pencil

            .d-flex.align-items-center.gap-2.mt-2
              if task.status === 'CLOSED'
                span.badge.text-bg-success Closed
              else if task.status === 'ARCHIVED'
                span.badge.text-bg-secondary Archived
              
              if task.dueLabel
                small.text-muted
                  i.bi.bi-calendar-event.me-1
                  | #{task.dueLabel}
              if task.location
                small.text-muted.ms-2
                  i.bi.bi-geo-alt.me-1
                  | #{task.location}

      // =============== Expired ===============
      section.mb-5
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0.text-danger Expired
            if safeLen(expired)
              span.badge.rounded-pill.bg-danger #{expired.length}
          if safeLen(expired) >= VIEW_LIMITS.EXPIRED
            a.btn.btn-sm.btn-link(href=`/tasks/list?groupId=${groupId}&status=OPEN&scope=EXPIRED`) View all
        
        if expired && expired.length
          .row.g-3
            each task in expired
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic.ps-2 No expired tasks.

      // =============== Today ===============
      section.mb-5
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0 Today
            if safeLen(today)
              span.badge.rounded-pill.bg-info.text-dark #{today.length}
          if safeLen(today) >= VIEW_LIMITS.TODAY
            a.btn.btn-sm.btn-link(href=`/tasks/list?groupId=${groupId}&status=OPEN&scope=TODAY`) View all

        if today && today.length
          .row.g-3
            each task in today
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic.ps-2 Nothing scheduled for today.

      // =============== No due date ===============
      section.mb-5
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0 No due date
            if safeLen(none)
              span.badge.rounded-pill.bg-secondary #{none.length}
          if safeLen(none) >= VIEW_LIMITS.NONE
            a.btn.btn-sm.btn-link(href=`/tasks/list?groupId=${groupId}&status=OPEN&scope=NONE`) View all

        if none && none.length
          .row.g-3
            each task in none
              .col-12.col-md-6
                +taskCard(task)
        else
          p.text-muted.fst-italic.ps-2 Nothing without due date.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    
    // =============== JavaScript: è™•ç†åœ˜éšŠä»»å‹™çš„ AJAX Mark Done ===============
    script.
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-mark-done').forEach(btn => {
          btn.addEventListener('click', async () => {
            const { id, csrf, canClose } = btn.dataset;
            
            async function submitClose(reason = null) {
              try {
                const response = await fetch(`/api/tasks/${id}/close`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrf },
                  body: JSON.stringify({ reason })
                });

                if (response.ok) {
                  window.location.reload();
                } else {
                  const result = await response.json();
                  if (result.message === 'FORCE_CLOSE_REASON_REQUIRED') {
                    const r = prompt('Task assignees or subtasks are not completed. Please provide a reason to force close:');
                    if (r !== null) await submitClose(r);
                  } else {
                    alert('Error: ' + result.message);
                  }
                }
              } catch (err) {
                alert('Network error.');
              }
            }

            if (canClose === 'false') {
              const reason = prompt('This team task has unfinished sub-items or assignees. Reason for closing?');
              if (reason !== null) await submitClose(reason);
            } else {
              if (confirm('Mark this group task as completed?')) {
                await submitClose();
              }
            }
          });
        });
      });