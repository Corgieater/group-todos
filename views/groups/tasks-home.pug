doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Group Tasks â€“ #{groupName || 'Group'}
    include ../partials/bootstrap

    style.
      .card .card-body { padding: 0.875rem 1rem; }
      .badge-assignee-initial {
        width: 28px; height: 28px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%; border: 1px solid var(--bs-border-color,#dee2e6);
        font-weight: 600;
        background-color: var(--bs-tertiary-bg);
      }
      .btn-review {
        --bs-btn-padding-y: .25rem;
        --bs-btn-padding-x: .5rem;
        --bs-btn-font-size: .75rem;
      }

  body
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p]||''} ${prioBorderMap[p]||'border-secondary'} border-2`;

        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;
        
        const ADMINISH = new Set(['OWNER','ADMIN']);
        const isAdminishViewer = ADMINISH.has(viewerRole?.role || viewerRole);
        const canManage = (t) => (isAdminishViewer || t.ownerId === viewerId);
        
        const VIEW_LIMITS = { EXPIRED: 5, TODAY: 15, NONE: 10 };

      // Header
      .row.mb-4.align-items-center
        .col
          h1.h4.mb-1 #{groupName || 'Group'} Tasks
          small.text-muted ğŸ‘¥ Role: #{viewerRole.role || viewerRole}
        .col-auto.text-end
          a.btn.btn-primary(href=`/groups/${groupId}/tasks/create`)
            i.bi.bi-plus-lg.me-1
            | New Task

      // ===== mixin =====
      mixin taskCard(task)
        -
          const first = task.assignees && task.assignees[0];
          const firstName = first && (first.name || first.email || '');
          const initial = firstName ? String(firstName).trim().charAt(0).toUpperCase() : null;
          const extraCount = Math.max(0, (task.assignees?.length || 0) - 1);

        .card.h-100.shadow-sm(class=cardClassForPrio(task.priority))
          .card-body
            .d-flex.flex-column.flex-md-row.justify-content-between.align-items-start.gap-2
              .d-flex.align-items-center.gap-2.flex-grow-1.min-w-0
                if initial
                  span.badge-assignee-initial(title=firstName)= initial
                h3.h6.card-title.mb-0.text-truncate
                  a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                if extraCount > 0
                  span.badge.rounded-pill.text-bg-secondary.ms-1(title=`+${extraCount} more assignees`)= `+${extraCount}`

              if canManage(task) && task.status === 'OPEN'
                .d-flex.gap-2
                  if task.isSmoothClose
                    //- æ–¹æ¡ˆ C-1: ç¶ è‰² Done æŒ‰éˆ• (ç„¡éœ€ç†ç”±)
                    button.btn.btn-success.btn-sm.btn-mark-done(
                      type="button"
                      data-id=task.id
                      data-csrf=csrfToken
                      data-mode="smooth"
                    )
                      i.bi.bi-check2-circle.me-1
                      | Done
                  else
                    //- æ–¹æ¡ˆ C-2: è—è‰² Review æŒ‰éˆ• (å¼•å°è‡³è©³æƒ…é å¯©æ ¸éºç•™é …)
                    a.btn.btn-outline-primary.btn-review(
                      href=`/tasks/${task.id}`
                      title=`${task.pendingCounts || 0} items pending. Click to review.`
                    )
                      i.bi.bi-search.me-1
                      | Review
                
            .d-flex.align-items-center.gap-2.mt-2
              if task.status === 'CLOSED'
                span.badge.text-bg-success Closed
              else if task.status === 'ARCHIVED'
                span.badge.text-bg-secondary Archived
              
              if task.dueLabel
                small.text-muted
                  i.bi.bi-calendar-event.me-1
                  | #{task.dueLabel}
              if task.location
                small.text-muted.ms-2
                  i.bi.bi-geo-alt.me-1
                  | #{task.location}

      // =============== Sections ===============
      each section in [{id: 'expired', label: 'Expired', data: expired, limit: VIEW_LIMITS.EXPIRED, color: 'danger'}, {id: 'today', label: 'Today', data: today, limit: VIEW_LIMITS.TODAY, color: 'info'}, {id: 'none', label: 'No due date', data: none, limit: VIEW_LIMITS.NONE, color: 'secondary'}]
        section.mb-5
          .d-flex.justify-content-between.align-items-center.mb-3
            .d-flex.align-items-baseline.gap-2
              h2.h5.mb-0(class=`text-${section.color}`)= section.label
              if safeLen(section.data)
                span.badge.rounded-pill(class=`bg-${section.color}`)= section.data.length
            if safeLen(section.data) >= section.limit
              a.btn.btn-sm.btn-link(href=`/tasks/list?groupId=${groupId}&status=OPEN&scope=${section.id.toUpperCase()}`) View all
          
          if section.data && section.data.length
            .row.g-3
              each task in section.data
                .col-12.col-md-6
                  +taskCard(task)
          else
            p.text-muted.fst-italic.ps-2 No tasks in this category.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    
    script.
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-mark-done').forEach(btn => {
          btn.addEventListener('click', async () => {
            const { id, csrf, mode } = btn.dataset;
            
            // åªæœ‰ isSmoothClose çš„ä»»å‹™æ‰æœƒå‡ºç¾åœ¨é€™è£¡
            if (mode === 'smooth') {
              if (confirm('Everything is completed. Mark this task as done?')) {
                try {
                  const response = await fetch(`/api/tasks/${id}/close`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrf },
                    body: JSON.stringify({ reason: null })
                  });

                  if (response.ok) {
                    window.location.reload();
                  } else {
                    const result = await response.json();
                    alert('Error: ' + result.message);
                  }
                } catch (err) {
                  alert('Network error.');
                }
              }
            }
          });
        });
      });