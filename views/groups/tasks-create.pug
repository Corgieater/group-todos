doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Create Group Task
    include ../partials/bootstrap
  body
    include ../partials/message
    include ../partials/header

    .container.py-4
      // 頁首
      .d-flex.align-items-center.justify-content-between.mb-3
        h1.h3.mb-0 Create Group Task
        if group && group.name
          span.badge.text-bg-secondary #{group.name}

      .card.shadow-sm
        .card-body
          -
            // 後端可傳：group, csrfToken, form(驗證失敗回填), members(可選，用於同時指派)
            const __form = (typeof form === 'object' && form) ? form : {};
            const __todayISO = new Date().toISOString().slice(0,10);
            const __allDayChecked =
              __form.allDay != null
                ? ['true','on','1','yes'].includes(String(__form.allDay).toLowerCase())
                : true;

          // 重要：action 依群組 id //see what going on
          form(action=actionPath, method="POST")
            input(type="hidden" name="_csrf" value=csrfToken)

            .row.g-3
              .col-12
                label.form-label(for="title") Title
                input#title.form-control(
                  type="text"
                  name="title"
                  required
                  value=(__form.title || '')
                  placeholder="e.g. Walk cat"
                )

              .col-12
                label.form-label(for="description") Description
                input#description.form-control(
                  type="text"
                  name="description"
                  value=(__form.description || '')
                  placeholder="Optional notes"
                )

              .col-md-6
                label.form-label(for="dueDate") Due date
                input#dueDate.form-control(
                  type="date"
                  name="dueDate"
                  value=(__form.dueDate || '')
                  min=__todayISO
                )

              .col-md-6
                .form-check.mt-4
                  // 取消勾選時也會送出 0
                  input(type="hidden" name="allDay" value="0")
                  input#allDay.form-check-input(
                    type="checkbox"
                    name="allDay"
                    value="1"
                    checked=__allDayChecked
                  )
                  label.form-check-label(for="allDay") All-day

              // 時間（全日會停用）
              .col-md-6#timeRow
                label.form-label(for="dueTime") Time
                input#dueTime.form-control(
                  type="time"
                  name="dueTime"
                  value=(__form.dueTime || '')
                )

              .col-md-6
                label.form-label(for="location") Location
                input#location.form-control(
                  type="text"
                  name="location"
                  value=(__form.location || '')
                  placeholder="Where is it?"
                )

              .col-md-6
                label.form-label(for="priority") Priority
                select#priority.form-select(name="priority")
                  option(value="1" selected=(String(__form.priority)==='1')) Urgent
                  option(value="2" selected=(String(__form.priority)==='2')) High
                  option(value="3" selected=(!__form.priority || String(__form.priority)==='3')) Medium
                  option(value="4" selected=(String(__form.priority)==='4')) Low

              // 可選：同時指派成員（若後端傳入 members 才顯示）
              if canAssign && members && members.length
                .col-12
                  label.form-label(for="assignees") Assign to members (optional)
                  select#assignees.form-select(name="assignees[]" multiple size=Math.min(6, members.length))
                    each m in members
                      -
                        const sel = Array.isArray(__form['assignees[]'])
                          ? __form['assignees[]'].map(String).includes(String(m.id))
                          : (Array.isArray(__form.assignees)
                              ? __form.assignees.map(String).includes(String(m.id))
                              : false);
                      option(value=m.id selected=sel)= `${m.name || m.email} (${m.email})`
                  .form-text Hold Ctrl/Cmd to select multiple

            .d-flex.flex-column.flex-md-row.justify-content-end.gap-2.mt-3
              a.btn.btn-outline-secondary.px-4(href=backPath) Cancel
              button#submitBtn.btn.btn-primary.px-4(type="submit")
                span#submitSpinner.spinner-border.spinner-border-sm.me-2.d-none(role="status" aria-hidden="true")
                i.bi.bi-check2-circle.me-1
                | Create Task

    // 互動：沿用你的行為（全日切換、time 最小值、提交動畫）
    script.
      const allDay = document.getElementById('allDay');
      const timeRow = document.getElementById('timeRow');
      const dateInput = document.getElementById('dueDate');
      const timeInput = document.getElementById('dueTime');

      function updateTimeVisibility() {
        if (!allDay || !timeRow || !timeInput) return;
        timeRow.style.opacity = allDay.checked ? 0.4 : 1;
        timeInput.disabled = allDay.checked;
        if (allDay.checked) timeInput.value = '';
      }

      function updateTimeMin() {
        if (!dateInput || !timeInput) return;
        const now = new Date();
        const sel = dateInput.value ? new Date(dateInput.value + 'T00:00:00') : null;
        if (sel && sel.toDateString() === now.toDateString()) {
          const pad = (n)=>String(n).padStart(2,'0');
          timeInput.min = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        } else {
          timeInput.removeAttribute('min');
        }
      }

      allDay && allDay.addEventListener('change', updateTimeVisibility);
      dateInput && dateInput.addEventListener('change', updateTimeMin);
      updateTimeVisibility();
      updateTimeMin();

      (function () {
        const formEl = document.querySelector('form[action^="/api/groups/"][action$="/tasks"]');
        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('submitSpinner');
        if (!formEl || !submitBtn || !spinner) return;

        formEl.addEventListener('submit', function () {
          submitBtn.disabled = true;
          spinner.classList.remove('d-none');
        });
      })();

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
