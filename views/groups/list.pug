doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title My Groups - Group Todos
    include ../partials/bootstrap
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css") 
    style.
      .table-hover tbody tr:hover { background-color: rgba(0,0,0,.02); }
      .pagination .page-link { color: #0d6efd; }
      .pagination .page-item.active .page-link { background-color: #0d6efd; border-color: #0d6efd; color: white; }

  body
    include ../partials/header
    .container.mt-3
      include ../partials/message

    .container.py-4
      .d-flex.justify-content-between.align-items-center.mb-4
        .d-flex.align-items-center.gap-3
          h2.h4.mb-0 ðŸ‘¥ My Groups
          if pageDto && pageDto.totalItems > 0
            span.badge.rounded-pill.bg-secondary #{pageDto.totalItems} Total
        
        a.btn.btn-primary(href="/groups/new")
          i.bi.bi-plus-lg.me-1
          | New Group

      if !groups || groups.length === 0
        .card.shadow-sm.border-0.bg-light
          .card-body.text-center.py-5
            i.bi.bi-people.display-1.text-muted.mb-3
            h3.h5 No groups yet.
            a.btn.btn-outline-primary.mt-2(href="/groups/new") Create Your First Group
      else
        .card.shadow-sm.border-0
          .table-responsive
            table.table.table-hover.align-middle.mb-0
              thead.table-light
                tr
                  th.ps-4(style="width: 50%") Group Name
                  th Created At
                  th.text-end.pe-4 Actions
              tbody
                each g in groups
                  tr
                    td.ps-4
                      a.fw-bold.text-decoration-none(href=`/groups/${g.id}`)
                        i.bi.bi-folder2-open.text-warning.me-2
                        | #{g.name}
                      //- æ”¹ç”¨ == é¿å…åž‹åˆ¥éŒ¯èª¤ï¼Œä¸¦ç¢ºèª currentUser.userId å­˜åœ¨
                      if currentUser && g.ownerId == (currentUser.userId || currentUser)
                        span.badge.bg-light.text-dark.border.ms-1.small.fw-normal(style="font-size: 0.7rem;") Owner
                    
                    td.text-muted.small
                      | #{new Date(g.createdAt).toLocaleDateString()}
                    
                    td.text-end.pe-4
                      .btn-group.btn-group-sm
                        a.btn.btn-outline-secondary(href=`/groups/${g.id}`, title="View") 
                          i.bi.bi-eye
                        a.btn.btn-outline-success(href=`/groups/${g.id}/tasks`, title="Tasks") 
                          i.bi.bi-list-check
                        
                        //- é—œéµä¿®æ­£ï¼šåˆ¤æ–· Owner æ¬Šé™é¡¯ç¤ºé‰›ç­†
                        if currentUser && g.ownerId == (currentUser.userId || currentUser)
                          button.btn.btn-outline-primary.btn-edit-group(
                            type="button"
                            data-bs-toggle="modal"
                            data-bs-target="#editGroupModal"
                            data-id=g.id
                            data-name=g.name
                          )
                            i.bi.bi-pencil

          if pageDto && pageDto.totalPages > 1
            .card-footer.bg-white.py-3
              nav
                ul.pagination.justify-content-center.mb-0
                  li.page-item(class=!pageDto.hasPreviousPage ? 'disabled' : '')
                    a.page-link(href=`?page=${pageDto.currentPage - 1}&limit=${pageDto.itemsPerPage}`) 
                      i.bi.bi-chevron-left
                  - for (let i = 1; i <= pageDto.totalPages; i++)
                    li.page-item(class=pageDto.currentPage === i ? 'active' : '')
                      a.page-link(href=`?page=${i}&limit=${pageDto.itemsPerPage}`) #{i}
                  li.page-item(class=!pageDto.hasNextPage ? 'disabled' : '')
                    a.page-link(href=`?page=${pageDto.currentPage + 1}&limit=${pageDto.itemsPerPage}`) 
                      i.bi.bi-chevron-right

    // Edit Modal
    #editGroupModal.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog.modal-dialog-centered
        .modal-content
          form#editGroupForm(method="POST")
            .modal-header
              h5.modal-title Edit Group Name
              button.btn-close(type="button" data-bs-dismiss="modal")
            .modal-body
              .mb-3
                label.form-label New Name
                input#modalGroupName.form-control(type="text" name="name" required)
              input(type="hidden" name="_csrf" value=csrfToken)
            .modal-footer
              button.btn.btn-link.text-decoration-none(type="button" data-bs-dismiss="modal") Cancel
              button.btn.btn-primary(type="submit") Update

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script.
      document.addEventListener('DOMContentLoaded', function() {
        const editGroupModal = document.getElementById('editGroupModal');
        if (editGroupModal) {
          editGroupModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('modalGroupName').value = button.getAttribute('data-name');
            document.getElementById('editGroupForm').action = `/api/groups/${button.getAttribute('data-id')}/update`;
          });
        }
      });