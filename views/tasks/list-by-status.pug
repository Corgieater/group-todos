doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title #{status} Tasks
    include ../partials/bootstrap

  body
    .container.py-4
      // flash è¨Šæ¯
      include ../partials/message

      // é é¦–
      include ../partials/header

      // ç‹€æ…‹ç¯©é¸åˆ‡æ› (Tabs)
      .card.shadow-sm.mb-4
        .card-body.py-2
          -
            // å–å¾—ç›®å‰ Query åƒæ•¸ä»¥åˆ¤æ–· active ç‹€æ…‹
            // currentQuery ä¾†è‡ª Controller å‚³å…¥
            const q = currentQuery || {};
            const curStatus = String(q.status || 'OPEN').toUpperCase();
            const curScope = String(q.scope || 'ALL').toUpperCase();

          ul.nav.nav-pills.justify-content-center
            // 1. å…¨éƒ¨é–‹æ”¾ (Open)
            li.nav-item
              a.nav-link(
                class=(curStatus === 'OPEN' && curScope !== 'FUTURE' ? 'active' : '')
                href="/tasks/list?status=OPEN"
              ) Open

            // 2. æœªä¾†ä»»å‹™ (Future)
            li.nav-item
              a.nav-link(
                class=(curScope === 'FUTURE' ? 'active' : '')
                href="/tasks/list?status=OPEN&scope=FUTURE"
              ) Future

            // 3. å·²å®Œæˆ (Closed)
            li.nav-item
              a.nav-link(
                class=(curStatus === 'CLOSED' ? 'active' : '')
                href="/tasks/list?status=CLOSED"
              ) Closed

      // ä»»å‹™æ¸…å–®
      -
        // å‹•æ…‹æ±ºå®šç©ºæ¸…å–®æç¤º
        let emptyHint = 'No tasks found.';
        if (curScope === 'FUTURE') emptyHint = 'No future tasks scheduled.';
        else if (curStatus === 'OPEN') emptyHint = 'You have no open tasks.';
        else if (curStatus === 'CLOSED') emptyHint = 'No closed tasks yet.';

        // æä¾›çµ¦ _tasks-list ä½¿ç”¨çš„è®Šæ•¸
        var currentStatus = curStatus; 
      
      include ./_tasks-list

      // --- ğŸš€ åˆ†é æ§åˆ¶å€ ---
      if pageMeta && pageMeta.pageCount > 1
        nav.mt-4(aria-label="Task pagination")
          ul.pagination.justify-content-center
            // ç¬¬ä¸€é  & ä¸Šä¸€é 
            li.page-item(class=(!pageMeta.hasPreviousPage ? 'disabled' : ''))
              a.page-link(href="javascript:void(0)" onclick=`changePage(1)`) 
                i.bi.bi-chevron-double-left
            li.page-item(class=(!pageMeta.hasPreviousPage ? 'disabled' : ''))
              a.page-link(href="javascript:void(0)" onclick=`changePage(${pageMeta.page - 1})`)
                i.bi.bi-chevron-left

            // é ç¢¼çª—å£é‚è¼¯
            - let start = Math.max(1, pageMeta.page - 2)
            - let end = Math.min(pageMeta.pageCount, start + 4)
            if (end - start < 4)
              - start = Math.max(1, end - 4)

            each p in Array.from({length: (end - start + 1)}, (_, i) => Math.max(1, start + i))
              li.page-item(class=(p === pageMeta.page ? 'active' : ''))
                a.page-link(href="javascript:void(0)" onclick=`changePage(${p})`)= p

            // ä¸‹ä¸€é  & æœ€å¾Œä¸€é 
            li.page-item(class=(!pageMeta.hasNextPage ? 'disabled' : ''))
              a.page-link(href="javascript:void(0)" onclick=`changePage(${pageMeta.page + 1})`)
                i.bi.bi-chevron-right
            li.page-item(class=(!pageMeta.hasNextPage ? 'disabled' : ''))
              a.page-link(href="javascript:void(0)" onclick=`changePage(${pageMeta.pageCount})`) 
                i.bi.bi-chevron-double-right

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")

    // --- ğŸš€ è…³æœ¬ï¼šä¿ç•™æ‰€æœ‰ç¯©é¸æ¢ä»¶ä¸¦è·³è½‰åˆ†é  ---
    script.
      function changePage(p) {
        if (!p) return;
        const url = new URL(window.location.href);
        // è¨­å®šæ–°çš„é ç¢¼ï¼ŒåŒæ™‚ URL ç‰©ä»¶æœƒè‡ªå‹•ä¿ç•™åŸæœ¬çš„ status, scope ç­‰åƒæ•¸
        url.searchParams.set('page', p);
        window.location.href = url.toString();
      }