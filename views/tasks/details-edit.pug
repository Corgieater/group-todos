doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title= title
    include ../partials/bootstrap
  body
    // 上方訊息（沿用你的 partial）
    include ../partials/message

    main.container.py-4
      .row.justify-content-center
        .col-12.col-md-8.col-lg-7
          .card.shadow-sm
            .card-body.p-4.p-md-5
              h1.h4.mb-4 Edit task

              form(action=`/api/tasks/${id}/update`, method="POST")
                input(type="hidden" name="_csrf" value=csrfToken) 
                // Title
                .mb-3
                  label.form-label(for="title") Title
                  input#title.form-control(type="text", name="title", required, value=(title || ''))

                // Description
                .mb-3
                  label.form-label(for="description") Description
                  input#description.form-control(type="text", name="description", value=(description || ''))

                // Due date
                .row.g-3
                  .col-sm-6
                    label.form-label(for="dueDate") Due date
                    input#dueDate.form-control(
                      type="date"
                      name="dueDate"
                      value=(dueDateLocal || '')
                      min=todayISO
                    )

                  // All day
                  .col-sm-6.d-flex.align-items-end
                    .form-check
                      input#allDay.form-check-input(type="checkbox", name="allDay", checked=!!allDay)
                      label.form-check-label(for="allDay") All day

                // Time row (hidden when all-day)
                .mb-3#timeRow
                  label.form-label(for="dueTime") Time
                  input#dueTime.form-control(
                    type="time"
                    name="dueTime"
                    value=(allDay ? '' : (dueTimeLocal || ''))
                  )

                // Location
                .mb-3
                  label.form-label(for="location") Location
                  input#location.form-control(type="text", name="location", value=(location || ''))

                // Priority
                .mb-4
                  label.form-label(for="priority") Priority
                  select#priority.form-select(name="priority")
                    option(value="", selected=!priority) — None —
                    option(value="1", selected=(priority === 1)) Urgent
                    option(value="2", selected=(priority === 2)) High
                    option(value="3", selected=(priority === 3)) Medium
                    option(value="4", selected=(priority === 4)) Low

                button.btn.btn-primary.w-100(type="submit") Submit

    // Bootstrap JS（給下拉/元件用）
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")

    // 行為腳本：與你原版相同（顯示/限制時間）
    script.
      (function () {
        var allDay = document.getElementById('allDay');
        var timeRow = document.getElementById('timeRow');
        var dateInput = document.getElementById('dueDate');
        var timeInput = document.getElementById('dueTime');

        function updateTimeVisibility() {
          if (!timeRow) return;
          timeRow.style.display = allDay.checked ? 'none' : '';
          if (allDay.checked && timeInput) timeInput.value = '';
        }

        function updateTimeMin() {
          if (!dateInput || !timeInput) return;
          var today = new Date();
          var selectedDate = dateInput.value ? new Date(dateInput.value) : null;
          if (selectedDate && selectedDate.toDateString() === today.toDateString()) {
            var pad = function (n) { return String(n).padStart(2,'0'); };
            timeInput.min = pad(today.getHours()) + ':' + pad(today.getMinutes());
          } else {
            timeInput.removeAttribute('min');
          }
        }

        if (allDay) allDay.addEventListener('change', updateTimeVisibility);
        if (dateInput) dateInput.addEventListener('change', updateTimeMin);

        updateTimeVisibility();
        updateTimeMin();
      })();
