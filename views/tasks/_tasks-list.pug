//- views/tasks/_tasks-list.pug
-
  const list = Array.isArray(viewModel) ? viewModel : [];
  const listStatus = typeof currentStatus === 'string' ? currentStatus : (typeof status === 'string' ? status : 'ALL');
  const isDoneTab = listStatus === 'FINISHED';
  const PRIORITY = { 1: 'Urgent', 2: 'High', 3: 'Medium', 4: 'Low' };
  const P_BADGE = { 1: 'danger', 2: 'warning', 3: 'info', 4: 'secondary' };

if !list.length
  .card.shadow-sm
    .card-body.text-center.py-5
      .display-6.mb-2 ğŸ—’ï¸
      p.lead.mb-3= emptyHint || 'No tasks.'
      a.btn.btn-primary(href="/tasks/create") + Create a task
else
  .card.shadow-sm
    .card-header.bg-body
      .d-flex.justify-content-between.align-items-center
        span.fw-semibold #{pageMeta.itemCount} task#{pageMeta.itemCount > 1 ? 's' : ''} found
    ul.list-group.list-group-flush
      each t in list
        -
          const p = PRIORITY[String(t.priority)] || 'â€”';
          const pb = P_BADGE[String(t.priority)] || 'secondary';
        li.list-group-item(id=`task-item-${t.id}`)
          .d-flex.gap-3.flex-column.flex-md-row.justify-content-between.align-items-start
            .flex-grow-1
              .d-flex.align-items-center.gap-2.mb-1
                if t.status === 'FINISHED' || isDoneTab
                  i.bi.bi-check2-circle.text-success
                else
                  i.bi.bi-circle

                h2.h6.mb-0
                  if t.title
                    a.text-decoration-none.text-truncate.d-inline-block(
                      href=`/tasks/${t.id}`
                      style="max-width: 18ch"
                      title=t.title
                    )= t.title
                  else
                    span.text-muted Untitled

                if t.priority
                  span.badge.ms-2(class=`text-bg-${pb}`)= p
                
                // ğŸ’¡ æç¤ºæœ‰æœªå®Œæˆå­é …ç›®
                if t.hasOpenItems
                  span.text-warning.ms-1(title="Has unfinished subtasks or assignees")
                    i.bi.bi-exclamation-triangle-fill

              .text-muted.small
                if t.dueLabel
                  span.me-3
                    i.bi.bi-calendar2-event.me-1
                    | #{t.dueLabel}
                if t.location
                  span.me-3
                    i.bi.bi-geo-alt.me-1
                    | #{t.location}

              if t.description
                p.mb-0.mt-2.text-truncate.d-inline-block.small.text-muted(style="max-width: 30ch")= t.description

            .d-flex.flex-wrap.gap-2
              if isDoneTab
                form(action=`/api/tasks/${t.id}/restore` method="POST")
                  input(type="hidden" name="_csrf" value=csrfToken)
                  button.btn.btn-outline-secondary.btn-sm(type="submit")
                    i.bi.bi-arrow-counterclockwise.me-1
                    | Restore
              else if t.status !== 'CLOSED'
                button.btn.btn-success.btn-sm.btn-mark-done(
                  type="button" 
                  data-id=t.id 
                  data-csrf=csrfToken
                  data-need-reason=(t.hasOpenItems ? "true" : "false")
                )
                  i.bi.bi-check2.me-1
                  | Mark done

              a.btn.btn-outline-primary.btn-sm(href=`/tasks/${t.id}/edit`)
                i.bi.bi-pencil-square.me-1
                | Edit

              form(action=`/api/tasks/${t.id}/disband` method="POST")
                input(type="hidden" name="_csrf" value=csrfToken)
                button.btn.btn-outline-danger.btn-sm(
                  type="submit"
                  onclick="return confirm('Delete this task?');"
                )
                  i.bi.bi-trash3.me-1
                  | Delete

script.
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-mark-done').forEach(btn => {
      btn.addEventListener('click', async () => {
        const { id, csrf, needReason } = btn.dataset;
        
        async function submitClose(reason = null) {
          try {
            const response = await fetch(`/api/tasks/${id}/close`, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'x-csrf-token': csrf 
              },
              body: JSON.stringify({ reason })
            });

            const result = await response.json();

            if (response.ok) {
              window.location.href = '/tasks/list';
            } else if (result.message === 'FORCE_CLOSE_REASON_REQUIRED') {
              const userReason = prompt('This task has unfinished items. Why are you closing it?');
              if (userReason !== null) await submitClose(userReason);
            } else {
              alert('Error: ' + (result.message || 'Unknown error'));
            }
          } catch (err) {
            alert('Network error, please try again.');
          }
        }

        // å¦‚æœé»æ“Šæ™‚å·²ç¶“çŸ¥é“éœ€è¦ç†ç”±ï¼Œå…ˆè·³ Prompt
        if (needReason === 'true') {
          const initialReason = prompt('This task has active subtasks/assignees. Provide a reason to close:');
          if (initialReason !== null) await submitClose(initialReason);
        } else {
          await submitClose();
        }
      });
    });
  });