doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title= title || 'Sub-Task Details'
    include ../partials/bootstrap
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css") 
  body
    include ../partials/message
    include ../partials/header
    include ../partials/_assign-member-form

    main.container.py-4
      -
        const prioColorMap = { 1: 'danger', 2: 'warning', 3: 'primary', 4: 'secondary' };
        const statusColorMap = { 'OPEN': 'warning', 'CLOSED': 'success', 'ARCHIVED': 'secondary' };
        const priorityClass = `text-bg-${prioColorMap[priority] || 'secondary'}`;
        const statusClass = `text-bg-${statusColorMap[status] || 'secondary'}`;

        const isGroup = typeof groupId !== 'undefined' && groupId !== null;
        const hasAssignees = Array.isArray(assignees) && assignees.length > 0;
        
        // --- æ¬Šé™é‚è¼¯ä¿®æ­£ ---
        const isOwner = typeof ownerId !== 'undefined' && Number(ownerId) === Number(currentUserId);
        
        // ðŸš€ 1. èª°èƒ½æ”¹æ¨™é¡Œ/å…§å®¹ï¼Ÿ (å¦‚æžœæ˜¯ç¾¤çµ„ä»»å‹™å‰‡å…¨å“¡çš†å¯ï¼Œå€‹äººä»»å‹™é™ Owner)
        const canEditSubTask = (isGroup || isOwner) && status === 'OPEN';

        // 2. èª°èƒ½åŸ·è¡Œã€Œå¼·è¡Œæ¢å¾©/ç®¡ç†ã€ï¼Ÿ (åƒ…é™ Admin)
        const canFinalizeSubTask = !!isAdminish;
        
        // 3. æª¢æŸ¥æŒ‡æ´¾è€…æ˜¯å¦å…¨æ¸…ä»¥æ±ºå®šæ˜¯å¦å¯ç›´æŽ¥é—œé–‰
        const allAssigneesCompleted = !assignees.some(a => ['PENDING', 'ACCEPTED'].includes(a.status));
        const subTaskCanClose = allAssigneesCompleted;

        // ðŸš€ æ±ºå®šæŒ‰éˆ•æ˜¯å¦ç¦ç”¨
        const isBtnDisabled = !subTaskCanClose && !canFinalizeSubTask;

        const editSubModalId = `editSubTaskModal-${id}`;
        const declineModalId = `declineModal-${id}`;
        const forbiddenModalId = `forbiddenSubModal-${id}`;

      .row.align-items-center.mb-3
        .col
          nav(aria-label="breadcrumb")
            ol.breadcrumb.mb-2
              li.breadcrumb-item: a(href=`/tasks/${taskId}`) Parent Task
              li.breadcrumb-item.active(aria-current="page") Sub-Task Details
          
          h1.h3.mb-1= title
          .d-flex.flex-wrap.gap-2.mt-2
            span.badge(class=priorityClass) Priority: #{priorityLabel}
            span.badge(class=statusClass) Status: #{statusLabel}
            if isGroup
              span.badge.text-bg-info Group Sub-task
            else
              span.badge.text-bg-secondary Personal Sub-task
        .col-auto
          .d-flex.gap-2
            if status === 'OPEN'
              button.btn#btn-main-close(
                type="button" 
                class=subTaskCanClose ? "btn-success" : "btn-warning"
                title=isBtnDisabled ? "Only administrators can close incomplete sub-tasks" : "Close sub-task"
                disabled=isBtnDisabled
              )
                i.bi.bi-check2-circle.me-1
                if isBtnDisabled
                  | Close (Admin Only)
                else
                  | Close

            if status === 'CLOSED' && canFinalizeSubTask
              form(action=`/api/tasks/${taskId}/sub-tasks/${id}/restore`, method="POST", class="d-inline")
                if typeof csrfToken !== 'undefined'
                  input(type="hidden", name="_csrf", value=csrfToken)
                button.btn.btn-outline-primary(type="submit" title="Reopen Sub-task")
                  i.bi.bi-arrow-counterclockwise.me-1
                  | Reopen

            //- ðŸš€ ä¿®æ”¹é»žï¼šç¾åœ¨åœ˜éšŠæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°ç·¨è¼¯æŒ‰éˆ•
            if canEditSubTask
              button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target=`#${editSubModalId}`)
                i.bi.bi-pencil-square.me-1
                | Edit

      if status === 'CLOSED' && closedBy
        .alert.alert-info.d-flex.align-items-center.mb-3(role="alert")
          i.bi.bi-info-circle-fill.me-2
          div
            | This sub-task was 
            strong closed
            |  by 
            span.badge.text-bg-light #{closedBy.name}
            |  on #{closedAtLabel || closedAt}

      // ===== Sub-task Assignees Card =====
      if isGroup
        .card.shadow-sm.mb-3
          .card-body
            .d-flex.justify-content-between.align-items-center.mb-3
              h2.h6.mb-0 Sub-task Assignees
              if status === 'OPEN' && !viewerIsAssignee && allowSelfAssign
                form(action=`/api/tasks/${taskId}/sub-tasks/${id}/update/assignee-status`, method="POST")
                  if typeof csrfToken !== 'undefined'
                    input(type="hidden", name="_csrf", value=csrfToken)
                  input(type="hidden", name="status", value="ACCEPTED")
                  button.btn.btn-sm.btn-primary(type="submit")
                    i.bi.bi-person-plus.me-1
                    | Claim Sub-task

            if hasAssignees
              .table-responsive
                table.table.table-sm.align-middle
                  thead
                    tr
                      th Member
                      th Status
                      th Updated
                  tbody
                    each a in assignees
                      - const stBadge = a.status === 'PENDING' ? 'secondary' : a.status === 'ACCEPTED' ? 'info' : a.status === 'DECLINED' ? 'warning' : a.status === 'COMPLETED' ? 'success' : 'secondary';
                      tr
                        td
                          strong= (a.assignee ? a.assignee.name : 'Unknown')
                          if a.assigneeId === viewerAssigneeId
                            span.badge.rounded-pill.text-bg-success.ms-2 You
                        td
                          span.badge(class=`text-bg-${stBadge}`)= a.status
                        td
                          span.text-muted.small= a.updatedAt
            else
              p.text-muted.fst-italic No one is assigned yet.

            if isAdminish && status === 'OPEN'
              .mt-3.mb-4.p-3.bg-light.rounded.border
                h3.h6.mb-2 
                  i.bi.bi-person-plus-fill.me-1
                  | Assign Member
                +assignMemberForm(`/api/tasks/${taskId}/sub-tasks/${id}/assign-sub-task`, groupMembers, csrfToken)

            if status === 'OPEN' && (viewerIsAssignee || allowSelfAssign)
              hr
              -
                const st = viewerAssigneeStatus || 'NONE';
                const canAccept   = st === 'PENDING' || st === 'DECLINED' || st === 'NONE' || st === 'COMPLETED';
                const canComplete = st === 'ACCEPTED'; 
                const canDecline  = st === 'PENDING' || st === 'ACCEPTED';

              h3.h6.mb-2 Update my status
              .d-flex.flex-wrap.gap-2
                if canAccept
                  form(action=`/api/tasks/${taskId}/sub-tasks/${id}/update/assignee-status`, method="POST", class="d-inline")
                    if typeof csrfToken !== 'undefined'
                      input(type="hidden", name="_csrf", value=csrfToken)
                    input(type="hidden", name="status", value="ACCEPTED")
                    button.btn.btn-outline-primary.btn-sm(type="submit")
                      i.bi.bi-hand-thumbs-up.me-1
                      if st === 'NONE'
                        | Claim
                      else if st === 'COMPLETED'
                        | Resume
                      else
                        | Accept

                if canComplete
                  form(action=`/api/tasks/${taskId}/sub-tasks/${id}/update/assignee-status`, method="POST", class="d-inline")
                    if typeof csrfToken !== 'undefined'
                      input(type="hidden", name="_csrf", value=csrfToken)
                    input(type="hidden", name="status", value="COMPLETED")
                    button.btn.btn-success.btn-sm(type="submit")
                      i.bi.bi-check2-circle.me-1
                      | Completed

                if canDecline
                  button.btn.btn-outline-danger.btn-sm(type="button" data-bs-toggle="modal" data-bs-target=`#${declineModalId}`)
                    i.bi.bi-x-circle.me-1
                    = (st === 'ACCEPTED' ? 'Withdraw' : 'Decline')

      // ===== Sub-task Info Card =====
      .card.shadow-sm.mb-3
        .card-body
          h2.h6.mb-3 Sub-task Info
          if description
            p.mb-3= description
          else
            p.text-muted.fst-italic.mb-3 No description.

          ul.list-group.list-group-flush
            li.list-group-item
              strong Due:&nbsp;
              if dueLabel
                | #{dueLabel}
                if allDay
                  span.badge.text-bg-warning.ms-2 All Day
              else
                span.text-muted Not set
            li.list-group-item
              strong Location:&nbsp;
              if location
                | #{location}
              else
                span.text-muted Not set
            li.list-group-item
              strong Created:&nbsp; #{createdLabel}
            li.list-group-item
              strong Updated:&nbsp; #{updatedLabel}

      // ===== ALL MODALS =====

      // 1. Edit Sub-task Modal
      if canEditSubTask
        .modal.fade(id=editSubModalId tabindex="-1" aria-hidden="true")
          .modal-dialog.modal-lg
            .modal-content
              .modal-header
                h5.modal-title Edit Sub-task
                button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
              form(action=`/api/tasks/${taskId}/sub-tasks/${id}/update`, method="POST")
                .modal-body.p-4
                  input(type="hidden" name="_csrf" value=csrfToken) 
                  .mb-3
                    label.form-label(for="title") Title
                    input#title.form-control(type="text", name="title", required, value=(title || ''))
                  .mb-3
                    label.form-label(for="description") Description
                    textarea#description.form-control(name="description", rows="3")= (description || '')
                  .row.g-3.mb-3
                    .col-sm-6
                      label.form-label(for="dueDate") Due date
                      input#dueDate.form-control(type="date", name="dueDate", value=(dueDateLocal || ''), min=todayISO)
                    .col-sm-6.d-flex.align-items-end
                      .form-check.mb-2
                        input#allDay.form-check-input(type="checkbox", name="allDay", checked=!!allDay)
                        label.form-check-label(for="allDay") All day
                  .mb-3#timeRow
                    label.form-label(for="dueTime") Time
                    input#dueTime.form-control(type="time", name="dueTime", value=(allDay ? '' : (dueTimeLocal || '')))
                  .mb-3
                    label.form-label(for="location") Location
                    input#location.form-control(type="text", name="location", value=(location || ''))
                  .mb-3
                    label.form-label(for="priority") Priority
                    select#priority.form-select(name="priority")
                      option(value="1", selected=(priority === 1)) Urgent
                      option(value="2", selected=(priority === 2)) High
                      option(value="3", selected=(priority === 3)) Medium
                      option(value="4", selected=(priority === 4)) Low
                .modal-footer
                  button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                  button.btn.btn-primary(type="submit") Save Changes

      // 2. Decline/Withdraw Modal
      if isGroup
        .modal.fade(id=declineModalId tabindex="-1" aria-hidden="true")
          .modal-dialog
            .modal-content
              .modal-header.bg-danger.text-white
                h5.modal-title Confirm Action
                button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
              form(action=`/api/tasks/${taskId}/sub-tasks/${id}/update/assignee-status`, method="POST")
                .modal-body
                  if typeof csrfToken !== 'undefined'
                    input(type="hidden", name="_csrf", value=csrfToken)
                  input(type="hidden", name="status", value="DECLINED")
                  p Are you sure you want to #{viewerAssigneeStatus === 'ACCEPTED' ? 'withdraw from' : 'decline'} this sub-task? 
                  p.small.text-muted This action will notify the task owner.
                .modal-footer
                  button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                  button.btn.btn-danger(type="submit") Confirm

      // 3. Forbidden Modal
      .modal.fade(id=forbiddenModalId tabindex="-1" aria-hidden="true")
        .modal-dialog
          .modal-content
            .modal-header.bg-light
              h5.modal-title 
                i.bi.bi-shield-lock.me-2.text-danger
                | Action Denied
              button.btn-close(type="button" data-bs-dismiss="modal")
            .modal-body.text-center.py-4
              i.bi.bi-exclamation-circle.text-warning(style="font-size: 3rem;")
              h4.mt-3 Cannot Close Sub-task
              p.text-muted This sub-task still has active assignees who haven't completed their work.
              p.small.text-primary Only administrators can bypass this check.
            .modal-footer
              button.btn.btn-primary(type="button" data-bs-dismiss="modal") Understood

      .mt-3
        a.link-secondary(href=`/tasks/${taskId}`) â† Back to parent task

    // ===== SCRIPTS =====
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script(src="https://cdn.socket.io/4.7.2/socket.io.min.js")
    
    script.
      (function () {
        const allDay = document.getElementById('allDay');
        const timeRow = document.getElementById('timeRow');
        function updateTimeVisibility() {
          if (!timeRow || !allDay) return;
          timeRow.style.display = allDay.checked ? 'none' : '';
        }
        if (allDay) allDay.addEventListener('change', updateTimeVisibility);
        updateTimeVisibility();
      })();

    script.
      (function() {
        const socket = io();
        const taskId = "#{taskId}";
        const subTaskId = "#{id}";
        const currentUserId = "#{currentUserId}";
        const canFinalize = "#{canFinalizeSubTask}" === "true";
        const subTaskCanClose = "#{subTaskCanClose}" === "true";
        const forbiddenModalEl = document.getElementById("#{forbiddenModalId}");
        const forbiddenModal = forbiddenModalEl ? new bootstrap.Modal(forbiddenModalEl) : null;

        socket.on('connect', () => socket.emit('joinTask', taskId));
        socket.on('taskUpdated', (data) => { 
          if (Number(data.actorId) !== Number(currentUserId)) {
            window.location.reload();
          }
        });

        const closeBtn = document.getElementById('btn-main-close');
        if (closeBtn) {
          closeBtn.addEventListener('click', async () => {
            if (!subTaskCanClose && !canFinalize) {
              if (forbiddenModal) forbiddenModal.show();
              return;
            }
            try {
              const res = await fetch(`/api/tasks/${taskId}/sub-tasks/${subTaskId}/close`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'x-csrf-token': '#{csrfToken}'
                }
              });
              if (res.ok) window.location.reload();
            } catch (e) {
              console.error('Network error', e);
            }
          });
        }
      })();