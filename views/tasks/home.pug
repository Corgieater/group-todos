doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Home - Tasks
    include ../partials/bootstrap
  body
    // 引入 Mixin 與共用組件
    include ../partials/_task-card
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        // Priority 配色
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p] || ''} ${prioBorderMap[p] || 'border-secondary'} border-2`;
        
        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;
        const totalTasks = safeLen(expired) + safeLen(today) + safeLen(none);
        
        // 對應 Service 的限制數量
        const LIMITS = { EXPIRED: 5, TODAY: 15, NONE: 10 };

      // Header 區塊
      .row.mb-3.align-items-center
        .col
          h1.h4.mb-1 #{name ? `Hi, ${name}` : 'All Tasks'}
          small.text-muted Focus on what needs to be done today
        .col-auto.text-end
          a.btn.btn-primary(href="/tasks/create")
            i.bi.bi-plus-lg.me-1
            | New Task

      hr.opacity-10

      // =============== Expired ===============
      section.mt-2
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0.text-danger Expired
            if safeLen(expired)
              span.badge.rounded-pill.bg-danger #{expired.length}
          if safeLen(expired) >= LIMITS.EXPIRED
            a.btn.btn-sm.btn-link.text-decoration-none(href="/tasks/list?status=OPEN&scope=EXPIRED") 
              | View all 
              i.bi.bi-arrow-right

        if expired && expired.length
          .row.g-3
            each task in expired
              +taskCard(task, csrfToken, cardClassForPrio)
        else
          .card.bg-light.border-0
            .card-body.text-center.text-muted.py-4
              i.bi.bi-calendar-x.display-6.mb-2.d-block
              p.mb-0 No overdue tasks. Good job!

      // =============== Today ===============
      section.mt-5
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0 Today
            if safeLen(today)
              span.badge.rounded-pill.bg-info.text-dark #{today.length}
          if safeLen(today) >= LIMITS.TODAY
            a.btn.btn-sm.btn-link.text-decoration-none(href="/tasks/list?status=OPEN&scope=TODAY")
              | View more 
              i.bi.bi-arrow-right

        if today && today.length
          .row.g-3
            each task in today
              +taskCard(task, csrfToken, cardClassForPrio)
        else
          .card.bg-light.border-0
            .card-body.text-center.text-muted.py-4
              i.bi.bi-sun.display-6.mb-2.d-block
              p.mb-0 Nothing scheduled for today.

      // =============== No due date ===============
      section.mt-5
        .d-flex.justify-content-between.align-items-center.mb-3
          .d-flex.align-items-baseline.gap-2
            h2.h5.mb-0 No due date
            if safeLen(none)
              span.badge.rounded-pill.bg-secondary #{none.length}
          if safeLen(none) >= LIMITS.NONE
            a.btn.btn-sm.btn-link.text-decoration-none(href="/tasks/list?status=OPEN&scope=NONE")
              | See all 
              i.bi.bi-arrow-right

        if none && none.length
          .row.g-3
            each task in none
              +taskCard(task, csrfToken, cardClassForPrio)
        else
          .card.bg-light.border-0
            .card-body.text-center.text-muted.py-4
              p.mb-0 You're all caught up on unscheduled tasks.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    include ../partials/notification-toast

    // =============== JavaScript: 處理首頁的 Mark Done 邏輯 ===============
    script.
      document.addEventListener('DOMContentLoaded', () => {
        // 監聽所有 Mark Done 按鈕 (假設 Mixin 內的按鈕 class 為 .btn-mark-done)
        document.querySelectorAll('.btn-mark-done').forEach(btn => {
          btn.addEventListener('click', async () => {
            const { id, csrf, canClose } = btn.dataset;
            
            async function submitClose(reason = null) {
              try {
                const response = await fetch(`/api/tasks/${id}/close`, {
                  method: 'POST',
                  headers: { 
                    'Content-Type': 'application/json',
                    'x-csrf-token': csrf 
                  },
                  body: JSON.stringify({ reason })
                });

                if (response.ok) {
                  // 首頁成功後直接刷新，反映最新 bucket 狀態
                  window.location.reload();
                } else {
                  const result = await response.json();
                  if (result.message === 'FORCE_CLOSE_REASON_REQUIRED') {
                    const userReason = prompt('This task is incomplete. Why are you closing it?');
                    if (userReason !== null) await submitClose(userReason);
                  } else {
                    alert('Error: ' + result.message);
                  }
                }
              } catch (err) {
                console.error('Request failed', err);
              }
            }

            // 如果 Service 判定無法直接關閉 (canClose 為 false)，先跳 Prompt
            if (canClose === 'false') {
              const reason = prompt('Task has unfinished sub-items. Please provide a reason to close:');
              if (reason !== null) await submitClose(reason);
            } else {
              if (confirm('Mark this task as done?')) {
                await submitClose();
              }
            }
          });
        });
      });