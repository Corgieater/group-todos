doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Tasks
    include ../partials/bootstrap
  body
    // Ë®äÊÅØËàáÂ∞éË¶ΩÂàó
    include ../partials/message
    include ../partials/header

    main.container.py-4
      -
        // Priority ÈÖçËâ≤Ôºàsubtle + ÈÇäÊ°ÜÔºâ
        const prioBgMap = { 1:'bg-danger-subtle', 2:'bg-warning-subtle', 3:'bg-primary-subtle', 4:'bg-secondary-subtle' };
        const prioBorderMap = { 1:'border-danger', 2:'border-warning', 3:'border-primary', 4:'border-secondary' };
        const cardClassForPrio = (p) => `${prioBgMap[p] || ''} ${prioBorderMap[p] || 'border-secondary'} border-2`;
        const safeLen = (arr) => Array.isArray(arr) ? arr.length : 0;
        const totalTasks = safeLen(expired) + safeLen(today) + safeLen(none);

        const isOpen = (t) => t.status === 'OPEN';
        const isClosed = (t) => t.status === 'CLOSED';
        const isArchived = (t) => t.status === 'ARCHIVED';

      // Header
      .row.mb-3
        .col
          h1.h4.mb-1 #{name ? `Hi, ${name}` : 'All Tasks'}
          small.text-muted Your personal tasks
        .col-auto.ms-auto.text-end
          span.badge.bg-primary-subtle.text-primary-emphasis.me-2 #{totalTasks}
          | tasks

      .mb-3
        a.btn.btn-sm.btn-outline-primary(href="/tasks/create")
          i.bi.bi-plus-lg.me-1
          | New Task

      // =============== Expired ===============
      section.mt-2
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Expired
          if safeLen(expired)
            span.badge.text-bg-danger #{expired.length}
        if expired && expired.length
          .row.g-3
            each task in expired
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  // Âè≥‰∏äËßíÂãï‰ΩúÔºö‰æùÁãÄÊÖãÂàáÊèõ
                  if isOpen(task)
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/close`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden", name="_csrf", value=csrfToken)
                      input(type="hidden", name="status", value="CLOSED")
                      button.btn.btn-success.btn-sm(type="submit" title="Close this task")
                        i.bi.bi-check2-circle.me-1
                        | Close
                  else if isClosed(task)
                    .position-absolute.top-0.end-0.m-2.btn-group
                      // Archive
                      form(directive="archive", action=`/api/tasks/${task.id}/update/status`, method="POST", class="me-1 d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="ARCHIVED")
                        button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive")
                          i.bi.bi-box-arrow-down.me-1
                          | Archive
                      // Reopen
                      form(directive="reopen", action=`/api/tasks/${task.id}/update/status`, method="POST", class="d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="OPEN")
                        button.btn.btn-outline-primary.btn-sm(type="submit" title="Reopen")
                          i.bi.bi-arrow-counterclockwise.me-1
                          | Reopen

                  .card-body
                    // ÁãÄÊÖãÂæΩÁ´†
                    if isArchived(task)
                      span.badge.text-bg-secondary.float-end(title="Archived") Archived
                    else if isClosed(task)
                      span.badge.text-bg-success.float-end(title="Closed") Closed

                    h3.h6.card-title.mb-1
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'

                    if task.allDay
                      if task.dueLabel
                        small.text-muted.d-block All-day: #{task.dueLabel}
                    else
                      if task.dueLabel
                        small.text-muted.d-block Due: #{task.dueLabel}

                    .row.mt-2.gx-2
                      .col-6
                        if task.location
                          small.text-muted.d-block.text-truncate üìç #{task.location}
                      .col-6
                        if task.description
                          small.text-muted.d-block.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
        else
          p.text-muted.fst-italic No expired tasks.

      // =============== Today ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 Today
          if safeLen(today)
            span.badge.text-bg-info #{today.length}
        if today && today.length
          .row.g-3
            each task in today
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  if isOpen(task)
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/close`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden", name="_csrf", value=csrfToken)
                      input(type="hidden", name="status", value="CLOSED")
                      button.btn.btn-success.btn-sm(type="submit" title="Close this task")
                        i.bi.bi-check2-circle.me-1
                        | Close
                  else if isClosed(task)
                    .position-absolute.top-0.end-0.m-2.btn-group
                      form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="me-1 d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="ARCHIVED")
                        button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive")
                          i.bi.bi-box-arrow-down.me-1
                          | Archive
                      form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="OPEN")
                        button.btn.btn-outline-primary.btn-sm(type="submit" title="Reopen")
                          i.bi.bi-arrow-counterclockwise.me-1
                          | Reopen

                  .card-body
                    if isArchived(task)
                      span.badge.text-bg-secondary.float-end Archived
                    else if isClosed(task)
                      span.badge.text-bg-success.float-end Closed

                    h3.h6.card-title.mb-1
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'

                    if task.allDay
                      if task.dueLabel
                        small.text-muted.d-block All-day: #{task.dueLabel}
                    else
                      if task.dueLabel
                        small.text-muted.d-block Due: #{task.dueLabel}

                    .row.mt-2.gx-2
                      .col-6
                        if task.location
                          small.text-muted.d-block.text-truncate üìç #{task.location}
                      .col-6
                        if task.description
                          small.text-muted.d-block.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
        else
          p.text-muted.fst-italic Nothing scheduled for today.

      // =============== No due date ===============
      section.mt-4
        .d-flex.align-items-baseline.mb-2.gap-2
          h2.h5.mb-0 No due date
          if safeLen(none)
            span.badge.text-bg-secondary #{none.length}
        if none && none.length
          .row.g-3
            each task in none
              .col-12.col-md-6
                .card.h-100.position-relative.shadow-sm(class=cardClassForPrio(task.priority))
                  if isOpen(task)
                    form.position-absolute.top-0.end-0.m-2(
                      action=`/api/tasks/${task.id}/close`
                      method="POST"
                    )
                      if typeof csrfToken !== 'undefined'
                        input(type="hidden", name="_csrf", value=csrfToken)
                      input(type="hidden", name="status", value="CLOSED")
                      button.btn.btn-success.btn-sm(type="submit" title="Close this task")
                        i.bi.bi-check2-circle.me-1
                        | Close
                  else if isClosed(task)
                    .position-absolute.top-0.end-0.m-2.btn-group
                      form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="me-1 d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="ARCHIVED")
                        button.btn.btn-outline-secondary.btn-sm(type="submit" title="Archive")
                          i.bi.bi-box-arrow-down.me-1
                          | Archive
                      form(action=`/api/tasks/${task.id}/update/status`, method="POST", class="d-inline")
                        if typeof csrfToken !== 'undefined'
                          input(type="hidden", name="_csrf", value=csrfToken)
                        input(type="hidden", name="status", value="OPEN")
                        button.btn.btn-outline-primary.btn-sm(type="submit" title="Reopen")
                          i.bi.bi-arrow-counterclockwise.me-1
                          | Reopen

                  .card-body
                    if isArchived(task)
                      span.badge.text-bg-secondary.float-end Archived
                    else if isClosed(task)
                      span.badge.text-bg-success.float-end Closed

                    h3.h6.card-title.mb-0
                      a.text-decoration-none(href=`/tasks/${task.id}`)= task.title || 'Untitled'
                    if task.description
                      p.small.text-muted.mt-1.mb-0.text-truncate(title=task.description) ‚úíÔ∏è #{task.description}
                    if task.location
                      small.text-muted.d-block.mt-1.text-truncate üìç #{task.location}
        else
          p.text-muted.fst-italic Nothing without due date.

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
