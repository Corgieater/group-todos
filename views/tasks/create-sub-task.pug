doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    // 1. 頁面標題修改
    title Create SubTask
    include ../partials/bootstrap
  body
    include ../partials/message
    include ../partials/header

    // 內容
    .container.py-4
      // 標題顯示父任務 ID (假設從後端傳入 parentTaskTitle)
      h1.h3.mb-3 Create SubTask for: #{parentTaskTitle}

      .card.shadow-sm
        .card-body
          -
            // 後端傳入的 form（可選）用來在驗證失敗時回填
            const __createForm = (typeof form === 'object' && form) ? form : {};
            const __todayISO = new Date().toISOString().slice(0,10);
            const __allDayChecked = (__createForm && __createForm.allDay != null)
              ? ['true','on','1','yes'].includes(String(__createForm.allDay).toLowerCase())
              : true;

          form(action=`/api/tasks/${parentTaskId}/sub-tasks`, method="POST")
            input(type="hidden" name="_csrf" value=csrfToken) 
            
            // 3. 隱藏欄位：傳遞 parentTaskId (必填)
            // 假設 parentTaskId 變數從後端渲染時傳入
            if parentTaskId
              input(type="hidden" name="parentTaskId" value=parentTaskId)
            else
              // 錯誤處理：如果沒有父任務 ID 則顯示錯誤或禁止提交
              p.alert.alert-danger 錯誤：找不到父任務 ID。

            // ⚠️ 備註: actorId 應該在後端從 Session/JWT/Cookie 中獲取，不應該通過表單傳遞。
            // 如果您的後端需要它，可以考慮在這裡加入隱藏欄位，但通常不建議。

            .row.g-3
              // Title (不變)
              .col-12
                label.form-label(for="title") Title
                input#title.form-control(
                  type="text"
                  name="title"
                  required
                  value=(__createForm.title || '')
                  placeholder="e.g. Call client"
                )

              // Description (不變)
              .col-12
                label.form-label(for="description") Description
                input#description.form-control(
                  type="text"
                  name="description"
                  value=(__createForm.description || '')
                  placeholder="Optional notes"
                )

              // Due date
              .col-md-6
                label.form-label(for="dueDate") Due date
                input#dueDate.form-control(
                  type="date"
                  name="dueDate"
                  value=(__createForm.dueDate || '')
                  min=__todayISO
                )

              // All-day Checkbox
              .col-md-6
                .form-check.mt-4
                  input(type="hidden" name="allDay" value="0")
                  input#allDay.form-check-input(
                    type="checkbox"
                    name="allDay"
                    value="1"
                    checked=__allDayChecked
                  )
                  label.form-check-label(for="allDay") All-day

              // Time (可被 All day 停用)
              .col-md-6#timeRow
                label.form-label(for="dueTime") Time
                input#dueTime.form-control(
                  type="time"
                  name="dueTime"
                  value=(__createForm.dueTime || '')
                )

              // Location
              .col-md-6
                label.form-label(for="location") Location
                input#location.form-control(
                  type="text"
                  name="location"
                  value=(__createForm.location || '')
                  placeholder="Where is it?"
                )
              
              // Priority
              .col-md-6
                label.form-label(for="priority") Priority
                select#priority.form-select(name="priority")
                  option(value="1" selected=(String(__createForm.priority)==='1')) Urgent
                  option(value="2" selected=(String(__createForm.priority)==='2')) High
                  option(value="3" selected=(!__createForm.priority || String(__createForm.priority)==='3')) Medium
                  option(value="4" selected=(String(__createForm.priority)==='4')) Low
              
              // Status (新增：子任務狀態通常預設 OPEN，但若允許使用者設定則保留)
              // 由於您的 SubTaskAddPayload 包含 status，我們保留選項
              // 假設您有一個 TaskStatus 的 Enum 或對應值
              // .col-md-6
              //   label.form-label(for="status") Status
              //   select#status.form-select(name="status")
              //     option(value="OPEN" selected=(!__createForm.status || String(__createForm.status)==='OPEN')) Open
              //     option(value="CLOSED" selected=(String(__createForm.status)==='CLOSED')) Closed
              //     option(value="ARCHIVED" selected=(String(__createForm.status)==='ARCHIVED')) Archived


              .d-flex.flex-column.flex-md-row.justify-content-end.gap-2.mt-3
                a.btn.btn-outline-secondary.px-4(href=`/tasks/${parentTaskId}`) Back to Task
                button#submitBtn.btn.btn-primary.px-4(type="submit" disabled=!parentTaskId)
                  span#submitSpinner.spinner-border.spinner-border-sm.me-2.d-none(role="status" aria-hidden="true")
                  i.bi.bi-plus-circle.me-1
                  | Create SubTask

    // JS（維持原本的互動行為）
    script.
      const allDay = document.getElementById('allDay');
      const timeRow = document.getElementById('timeRow');
      const dateInput = document.getElementById('dueDate');
      const timeInput = document.getElementById('dueTime');

      function updateTimeVisibility() {
        if (!allDay || !timeRow || !timeInput) return;
        timeRow.style.opacity = allDay.checked ? 0.4 : 1;
        timeInput.disabled = allDay.checked;
        if (allDay.checked) timeInput.value = '';
      }

      function updateTimeMin() {
        if (!dateInput || !timeInput) return;
        const now = new Date();
        const sel = dateInput.value ? new Date(dateInput.value + 'T00:00:00') : null;
        if (sel && sel.toDateString() === now.toDateString()) {
          const pad = (n)=>String(n).padStart(2,'0');
          timeInput.min = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        } else {
          timeInput.removeAttribute('min');
        }
      }

      allDay && allDay.addEventListener('change', updateTimeVisibility);
      dateInput && dateInput.addEventListener('change', updateTimeMin);
      updateTimeVisibility();
      updateTimeMin();

      (function () {
      const formEl = document.querySelector('form[action^="/api/tasks"]');
      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('submitSpinner');
      if (!formEl || !submitBtn || !spinner) return;

      formEl.addEventListener('submit', function () {
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
      });
      })();

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")