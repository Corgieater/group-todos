doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title Create Task
    include ../partials/bootstrap
  body
    // 上方訊息（沿用你的 partial）
    include ../partials/message
    include ../partials/header

    // 內容
    .container.py-4
      h1.h3.mb-3 Create Task

      .card.shadow-sm
        .card-body
          //- 後端傳入的 form（可選）用來在驗證失敗時回填
          -
            // 用唯一名稱，避免與 partial 內變數衝突
            const __createForm = (typeof form === 'object' && form) ? form : {};
            const __todayISO = new Date().toISOString().slice(0,10);
            const __allDayChecked = (__createForm && __createForm.allDay != null)
              ? ['true','on','1','yes'].includes(String(__createForm.allDay).toLowerCase())
              : true;

          form(action="/api/tasks", method="POST")
              input(type="hidden" name="_csrf" value=csrfToken) 
              .row.g-3
              .col-12
                label.form-label(for="title") Title
                input#title.form-control(
                  type="text"
                  name="title"
                  required
                  value=(__createForm.title || 'walk cat')
                  placeholder="e.g. Walk cat"
                )

              .col-12
                label.form-label(for="description") Description
                input#description.form-control(
                  type="text"
                  name="description"
                  value=(__createForm.description || '')
                  placeholder="Optional notes"
                )

              .col-md-6
                label.form-label(for="dueDate") Due date
                input#dueDate.form-control(
                  type="date"
                  name="dueDate"
                  value=(__createForm.dueDate || '')
                  min=__todayISO
                )

              .col-md-6
                .form-check.mt-4
                  input#allDay.form-check-input(
                    type="checkbox"
                    name="allDay"
                    value="true"
                    checked=__allDayChecked
                  )
                  label.form-check-label(for="allDay") All-day

              //- 時間（可被 All day 停用）
              .col-md-6#timeRow
                label.form-label(for="dueTime") Time
                input#dueTime.form-control(
                  type="time"
                  name="dueTime"
                  value=(__createForm.dueTime || '')
                )

              .col-md-6
                label.form-label(for="location") Location
                input#location.form-control(
                  type="text"
                  name="location"
                  value=(__createForm.location || '')
                  placeholder="Where is it?"
                )

              .col-md-6
                label.form-label(for="priority") Priority
                select#priority.form-select(name="priority")
                  option(value="1" selected=(String(__createForm.priority)==='1')) Urgent
                  option(value="2" selected=(String(__createForm.priority)==='2')) High
                  option(value="3" selected=(!__createForm.priority || String(__createForm.priority)==='3')) Medium
                  option(value="4" selected=(String(__createForm.priority)==='4')) Low
              .d-flex.flex-column.flex-md-row.justify-content-end.gap-2.mt-3
                a.btn.btn-outline-secondary.px-4(href="/tasks/list?status=UNFINISHED") Cancel
                button#submitBtn.btn.btn-primary.px-4(type="submit")
                  span#submitSpinner.spinner-border.spinner-border-sm.me-2.d-none(role="status" aria-hidden="true")
                  i.bi.bi-check2-circle.me-1
                  | Create Task

    // JS（維持你原本的互動行為）
    script.
      const allDay = document.getElementById('allDay');
      const timeRow = document.getElementById('timeRow');
      const dateInput = document.getElementById('dueDate');
      const timeInput = document.getElementById('dueTime');

      function updateTimeVisibility() {
        if (!allDay || !timeRow || !timeInput) return;
        timeRow.style.opacity = allDay.checked ? 0.4 : 1;
        timeInput.disabled = allDay.checked;
        if (allDay.checked) timeInput.value = '';
      }

      function updateTimeMin() {
        if (!dateInput || !timeInput) return;
        const now = new Date();
        const sel = dateInput.value ? new Date(dateInput.value + 'T00:00:00') : null;
        if (sel && sel.toDateString() === now.toDateString()) {
          const pad = (n)=>String(n).padStart(2,'0');
          timeInput.min = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
        } else {
          timeInput.removeAttribute('min');
        }
      }

      allDay && allDay.addEventListener('change', updateTimeVisibility);
      dateInput && dateInput.addEventListener('change', updateTimeMin);
      updateTimeVisibility();
      updateTimeMin();

      (function () {
      const formEl = document.querySelector('form[action="/api/tasks"]');
      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('submitSpinner');
      if (!formEl || !submitBtn || !spinner) return;

      formEl.addEventListener('submit', function () {
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
      });
      })();

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
    script.
      (function validateInputs() {
        if (!allDay.checked) {
          // 如果不是全天任務，日期應該要必填
          dateInput.required = true;
        } else {
          dateInput.required = false;
        }
      }

      allDay.addEventListener('change', validateInputs);
      validateInputs();) // 初始化執行一次