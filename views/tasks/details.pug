doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    title= title || 'Task Details'
    include ../partials/bootstrap
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css") 
  body
    include ../partials/message
    include ../partials/header
    include ../partials/_assign-member-form

    main.container.py-4
      -
        const prioColorMap = { 1: 'danger', 2: 'warning', 3: 'primary', 4: 'secondary' };
        const statusColorMap = { 'OPEN': 'warning', 'CLOSED': 'success', 'ARCHIVED': 'secondary' };
        const priorityClass = `text-bg-${prioColorMap[priority] || 'secondary'}`;
        const statusClass = `text-bg-${statusColorMap[status] || 'secondary'}`;

        const isGroup = typeof groupId !== 'undefined' && groupId !== null;
        const groupName = group ? group.name : null;
        
        // --- Ê¨äÈôêÈÇèËºØÂØ¶‰Ωú ---
        // 1. Ë™∞ËÉΩÊîπÊ®ôÈ°å/ÂÖßÂÆπÔºü (Admin Êàñ Owner)
        const canEditTask = !!isAdminish || (typeof ownerId !== 'undefined' && Number(ownerId) === Number(currentUserId));
        // 2. Ë™∞ËÉΩÂü∑Ë°å„ÄåÂº∑Ë°åÈóúÈñâ„ÄçÊàñ„ÄåÂ∞ÅÂ≠ò„ÄçÔºü (ÂÉÖÈôê Admin)
        const canFinalizeTask = !!isAdminish;
        // 3. Ë™∞ËÉΩÂü∑Ë°å„ÄåÊ≠£Â∏∏ÈóúÈñâ„ÄçÔºü (Ê™¢Êü•Â≠ê‰ªªÂãôÊòØÂê¶ÂÖ®Ê∏Ö)
        const taskCanClose = typeof canClose !== 'undefined' ? !!canClose : false; 
        
        // üöÄ ÈóúÈçµ‰øÆÊîπÔºöÊ±∫ÂÆöÊåâÈàïÊòØÂê¶È°ØÁ§∫ÁÇ∫ÁÅ∞Ëâ≤ (Disabled)
        // Â¶ÇÊûú‰ªªÂãôÊ≤íÂÅöÂÆåÔºå‰∏î‰ΩøÁî®ËÄÖ‰∏çÊòØ AdminÔºåÂ∞±Á¶ÅÁî®ÊåâÈàï
        const isBtnDisabled = !taskCanClose && !canFinalizeTask;
        
        // Ê±∫ÂÆöÊòØÂê¶È°ØÁ§∫ÈóúÈñâÊåâÈàïÔºöAdmin Èö®ÊôÇÂèØË¶ãÔºåOwner ‰∫¶ÂèØË¶ã (‰ΩÜËã•Êú™ÂÆåÊàêÂâáÊúÉËÆäÁÅ∞)
        const canShowCloseBtn = canFinalizeTask || canEditTask;

        const editModalId = `editTaskModal-${id}`;
        const forceCloseModalId = `forceCloseModal-${id}`;
        const forbiddenModalId = `forbiddenModal-${id}`;
        const declineModalId = `declineModal-${id}`;

      .row.align-items-center.mb-3
        .col
          h1.h3.mb-1= title
          #typing-indicator.text-muted.small.fw-bold.d-none
            i.bi.bi-pencil-fill.me-1
            span#typing-text
          .d-flex.flex-wrap.gap-2.mt-2
            span.badge(class=priorityClass) Priority: #{priorityLabel}
            span.badge(class=statusClass) Status: #{statusLabel}
            if isGroup
              span.badge.text-bg-info Group
            else
              span.badge.text-bg-secondary Personal
        .col-auto
          .d-flex.gap-2
            if status === 'OPEN'
              if canFinalizeTask
                form(action=`/api/tasks/${id}/archive`, method="POST", class="d-inline")
                  if typeof csrfToken !== 'undefined'
                    input(type="hidden", name="_csrf", value=csrfToken)
                  button.btn.btn-outline-secondary(type="submit" title="Archive")
                    i.bi.bi-box-arrow-down.me-1
                    | Archive
              
              if canShowCloseBtn
                //- üöÄ ‰øÆÊîπÈªûÔºöÂä†ÂÖ• disabled Â±¨ÊÄßËàáÊñáÂ≠óÂà§Êñ∑
                button.btn#btn-main-close(
                  type="button" 
                  class=taskCanClose ? "btn-success" : "btn-warning"
                  title=isBtnDisabled ? "Only administrators can force close incomplete tasks" : "Close task"
                  disabled=isBtnDisabled
                )
                  i.bi.bi-check2-circle.me-1
                  if isBtnDisabled
                    | Force Close (Admin Only)
                  else
                    | #{taskCanClose ? 'Close' : 'Force Close'}

            else if status !== 'OPEN' && canFinalizeTask
              form(action=`/api/tasks/${id}/restore`, method="POST", class="d-inline")
                if typeof csrfToken !== 'undefined'
                  input(type="hidden", name="_csrf", value=csrfToken)
                button.btn.btn-outline-primary(type="submit" title="Reopen")
                  i.bi.bi-arrow-counterclockwise.me-1
                  | Reopen

            if canEditTask
              button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target=`#${editModalId}`)
                i.bi.bi-pencil-square.me-1
                | Edit

      // ===== Task Main Card =====
      .card.shadow-sm.mb-3
        .card-body
          if description
            p.mb-3= description
          else
            p.text-muted.fst-italic.mb-3 No description.

          ul.list-group.list-group-flush
            li.list-group-item
              strong Due:&nbsp;
              if dueLabel
                | #{dueLabel}
                if allDay
                  span.badge.text-bg-warning.ms-2 All Day
              else
                span.text-muted Not set
            li.list-group-item
              strong Location:&nbsp;
              if location
                | #{location}
              else
                span.text-muted Not set
            if isGroup && groupName
              li.list-group-item
                strong Group:&nbsp; 
                | #{groupName}
            li.list-group-item
              strong Created:&nbsp; #{createdLabel}
            li.list-group-item
              strong Updated:&nbsp; #{updatedLabel}
            if closedReason
              li.list-group-item.list-group-item-warning
                strong Closure Reason:&nbsp; 
                span.fst-italic= closedReason

      // ===== Sub Tasks Section =====
      .card.shadow-sm.mb-3
        .card-body
          .d-flex.align-items-center.justify-content-between.mb-3
            h2.h5.mb-0 Sub Tasks
            if canEditTask
              a.btn.btn-sm.btn-primary(href=`/tasks/${id}/sub-tasks/create`)
                i.bi.bi-plus-lg.me-1
                | Add SubTask
          
          #subtask-list-container
            include ../partials/_subtask-list.pug

      // ===== Assignees Section =====
      if isGroup
        .card.shadow-sm.mb-3
          .card-body
            h2.h6.mb-3 Task Assignees
            if Array.isArray(assignees) && assignees.length > 0
              .table-responsive
                table.table.table-sm.align-middle
                  tbody
                    each a in assignees
                      - const stBadge = a.status === 'PENDING' ? 'secondary' : a.status === 'ACCEPTED' ? 'info' : a.status === 'DECLINED' ? 'warning' : a.status === 'COMPLETED' ? 'success' : 'secondary';
                      tr
                        td #{a.assignee ? a.assignee.name : 'Unknown'}
                        td: span.badge(class=`text-bg-${stBadge}`)= a.status
            
            if isAdminish
              .mt-3.mb-4.p-3.bg-light.rounded.border
                h3.h6.mb-2 
                  i.bi.bi-person-plus-fill.me-1
                  | Assign Member
                +assignMemberForm(`/api/tasks/${id}/assign-task`, groupMembers, csrfToken)
            
            hr
            
            if (viewerIsAssignee || allowSelfAssign) && status === 'OPEN'
              -
                const st = viewerAssigneeStatus || 'NONE';
                const canAccept   = st === 'PENDING' || st === 'DECLINED' || st === 'NONE' || st === 'COMPLETED';
                const canComplete = st === 'ACCEPTED'; 
                const canDecline  = st === 'PENDING' || st === 'ACCEPTED';

              h3.h6.mb-2 Update my status
              .d-flex.flex-wrap.gap-2
                if canAccept
                  form(action=`/api/tasks/${id}/update/assignee-status`, method="POST", class="d-inline")
                    if typeof csrfToken !== 'undefined'
                      input(type="hidden", name="_csrf", value=csrfToken)
                    input(type="hidden", name="status", value="ACCEPTED")
                    button.btn.btn-outline-primary.btn-sm(type="submit")
                      i.bi.bi-hand-thumbs-up.me-1
                      if st === 'NONE'
                        | Join Task
                      else if st === 'COMPLETED'
                        | Resume Task
                      else
                        | Accept Task

                if canComplete
                  form(action=`/api/tasks/${id}/update/assignee-status`, method="POST", class="d-inline")
                    if typeof csrfToken !== 'undefined'
                      input(type="hidden", name="_csrf", value=csrfToken)
                    input(type="hidden", name="status", value="COMPLETED")
                    button.btn.btn-success.btn-sm(type="submit")
                      i.bi.bi-check2-circle.me-1
                      | Mark as Completed

                if canDecline
                  button.btn.btn-outline-danger.btn-sm(type="button" data-bs-toggle="modal" data-bs-target=`#${declineModalId}`)
                    i.bi.bi-x-circle.me-1
                    = (st === 'ACCEPTED' ? 'Withdraw' : 'Decline')

      // ===== MODALS =====
      if canEditTask
        .modal.fade(id=editModalId tabindex="-1" aria-hidden="true")
          .modal-dialog.modal-lg
            .modal-content
              .modal-header
                h5.modal-title Edit Task
                button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
              form(action=`/api/tasks/${id}/update`, method="POST")
                .modal-body.p-4
                  input(type="hidden" name="_csrf" value=csrfToken) 
                  .mb-3
                    label.form-label(for="title") Title
                    input#title.form-control(type="text", name="title", required, value=(title || ''))
                  .mb-3
                    label.form-label(for="description") Description
                    textarea#description.form-control(name="description", rows="3")= (description || '')
                  .row.g-3.mb-3
                    .col-sm-6
                      label.form-label(for="dueDate") Due date
                      input#dueDate.form-control(type="date", name="dueDate", value=(dueDateLocal || ''), min=todayISO)
                    .col-sm-6.d-flex.align-items-end
                      .form-check.mb-2
                        input#allDay.form-check-input(type="checkbox", name="allDay", checked=!!allDay)
                        label.form-check-label(for="allDay") All day
                  .mb-3#timeRow
                    label.form-label(for="dueTime") Time
                    input#dueTime.form-control(type="time", name="dueTime", value=(allDay ? '' : (dueTimeLocal || '')))
                  .mb-3
                    label.form-label(for="location") Location
                    input#location.form-control(type="text", name="location", value=(location || ''))
                  .mb-3
                    label.form-label(for="priority") Priority
                    select#priority.form-select(name="priority")
                      option(value="1", selected=(priority === 1)) Urgent
                      option(value="2", selected=(priority === 2)) High
                      option(value="3", selected=(priority === 3)) Medium
                      option(value="4", selected=(priority === 4)) Low
                .modal-footer
                  button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                  button.btn.btn-primary(type="submit") Save Changes

      if canFinalizeTask
        .modal.fade(id=forceCloseModalId tabindex="-1" aria-hidden="true")
          .modal-dialog
            .modal-content
              .modal-header.bg-warning.text-dark
                h5.modal-title 
                  i.bi.bi-exclamation-triangle-fill.me-2
                  | Force Close Required
                button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
              form#forceCloseForm
                .modal-body
                  p.text-muted The task is not yet fully completed. To force closure, please enter a reason:
                  textarea.form-control(name="reason" rows="3" placeholder="For example: manual approval by the administrator..." required)
                .modal-footer
                  button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                  button.btn.btn-warning#btn-confirm-force-close(type="submit") Confirm Force Close

      //- üöÄ ÊãíÁµïÂΩàÁ™ó
      .modal.fade(id=forbiddenModalId tabindex="-1" aria-hidden="true")
        .modal-dialog
          .modal-content
            .modal-header.bg-light
              h5.modal-title 
                i.bi.bi-shield-lock.me-2.text-danger
                | Action Required
              button.btn-close(type="button" data-bs-dismiss="modal")
            .modal-body.text-center.py-4
              i.bi.bi-exclamation-circle.text-warning(style="font-size: 3rem;")
              h4.mt-3 Close Task Denied
              p.text-muted You cannot close this task yet because there are incomplete sub-tasks or active assignees.
              p.small.text-primary Only group administrators can perform a "Force Close".
            .modal-footer
              button.btn.btn-primary(type="button" data-bs-dismiss="modal") Understood

      .modal.fade(id=declineModalId tabindex="-1" aria-hidden="true")
        .modal-dialog
          .modal-content
            .modal-header.bg-danger.text-white
              h5.modal-title Confirm Action
              button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal" aria-label="Close")
            form(action=`/api/tasks/${id}/update/assignee-status`, method="POST")
              .modal-body
                if typeof csrfToken !== 'undefined'
                  input(type="hidden", name="_csrf", value=csrfToken)
                input(type="hidden", name="status", value="DECLINED")
                p Are you sure you want to #{viewerAssigneeStatus === 'ACCEPTED' ? 'withdraw from' : 'decline'} this task? 
              .modal-footer
                button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
                button.btn.btn-danger(type="submit") Confirm

      #liveToastContainer.toast-container.position-fixed.bottom-0.end-0.p-3(style="z-index: 1080;")

      .mt-3
        a.link-secondary(href="/tasks/home") ‚Üê Back to home

    // ===== SCRIPTS =====
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script(src="https://cdn.socket.io/4.7.2/socket.io.min.js")
    script.
      (function () {
        const socket = io();
        const taskId = "#{id}";
        const currentUserId = "#{currentUserId}";
        const currentUserName = "#{currentUserName || 'Someone'}"; 

        // Ê¨äÈôêÊ®ôË®ò‰æõ JS Âà§Êñ∑
        const canFinalize = "#{canFinalizeTask}" === "true";
        const taskCanClose = "#{taskCanClose}" === "true";
        
        // ÂàùÂßãÂåñ Modals
        const forceCloseModalEl = document.getElementById("#{forceCloseModalId}");
        const forceCloseModal = forceCloseModalEl ? new bootstrap.Modal(forceCloseModalEl) : null;
        const forbiddenModal = new bootstrap.Modal(document.getElementById("#{forbiddenModalId}"));

        const liveToastContainer = document.getElementById('liveToastContainer');

        function showToast(msg, type = 'primary') {
          if (!liveToastContainer) return;
          const id = 't-' + Date.now();
          const html = `<div id="${id}" class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert"><div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
          liveToastContainer.insertAdjacentHTML('beforeend', html);
          new bootstrap.Toast(document.getElementById(id), { autohide: true, delay: 5000 }).show();
        }

        socket.on('connect', () => socket.emit('joinTask', taskId));
        
        async function attemptClose(reason = null) {
          // JS Â±§Á¥öÊîîÊà™ÔºöÈõôÈáç‰øùÈö™
          if (!taskCanClose && !canFinalize) {
            forbiddenModal.show();
            return;
          }

          try {
            const res = await fetch(`/api/tasks/${taskId}/close`, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'x-csrf-token': '#{csrfToken}'
              },
              body: JSON.stringify({ reason })
            });

            if (res.ok) {
              window.location.reload();
            } else {
              const err = await res.json(); 
              
              if (err.action === 'FORCE_CLOSE_REASON_REQUIRED') {
                if (canFinalize && forceCloseModal) {
                  forceCloseModal.show();
                } else {
                  forbiddenModal.show();
                }
              } else {
                showToast(err.message || 'Error', 'danger');
              }
            }
          } catch (e) {
            showToast('Network error', 'danger');
          }
        }

        document.getElementById('btn-main-close')?.addEventListener('click', () => attemptClose());
        
        document.getElementById('forceCloseForm')?.addEventListener('submit', (e) => {
          e.preventDefault();
          const reason = e.target.querySelector('textarea[name="reason"]').value;
          attemptClose(reason);
        });

        const setupTyping = (id) => {
          document.getElementById(id)?.addEventListener('input', () => {
            if (!this.isTypingSent) {
              socket.emit('typing', { taskId, userName: currentUserName });
              this.isTypingSent = true;
              setTimeout(() => { this.isTypingSent = false; }, 2000);
            }
          });
        };
        setupTyping('title'); setupTyping('description');
      })();