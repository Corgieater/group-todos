enum Status {
  OPEN
  CLOSED
  ARCHIVED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
  SKIPPED
  DROPPED
}

enum CompletionPolicy {
  ALL_ASSIGNEES
  ANY_ASSIGNEE
}

model Task {
  id      Int  @id @default(autoincrement())
  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  groupId Int?
  group   Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  title       String
  status      Status  @default(OPEN)
  priority    Int     @default(3)
  description String?
  location    String?

  subTasks SubTask[]

  // 時間欄位（關鍵）
  // 1) 一般事件/截止時間 -> 存 UTC
  dueAtUtc        DateTime?  @db.Timestamptz(6)// 以 UTC 儲存的絕對時間點（nullable）
  // 2) All-day 事件 -> 用當地的「日期」表示
  allDay          Boolean   @default(true)
  allDayLocalDate DateTime? @db.Date // 僅日期；若 allDay=true，則這欄必有值
  // 3) 來源時區（輸入時的時區），IANA
  sourceTimeZone  String?   @db.VarChar(64)

  assignees TaskAssignee[]

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  completionPolicy CompletionPolicy @default(ALL_ASSIGNEES)
  closedAt         DateTime?
  closedById       Int?
  closedReason     String?

  closedWithOpenAssignees Boolean @default(false)

  @@index([ownerId, status, priority])
  @@index([groupId, status, priority])
  @@index([dueAtUtc])
  @@index([allDay, allDayLocalDate])
}

model TaskAssignee {
  taskId       Int
  assigneeId   Int
  assignedById Int

  status AssignmentStatus @default(PENDING)
  reason String?

  assignedAt  DateTime  @default(now())
  acceptedAt  DateTime? @db.Timestamptz(6)
  declinedAt  DateTime? @db.Timestamptz(6)
  completedAt DateTime? @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(6)

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignee   User @relation("AssigneeUser", fields: [assigneeId], references: [id], onDelete: Cascade)
  assignedBy User @relation("AssignedByUser", fields: [assignedById], references: [id], onDelete: SetNull)

  @@id([taskId, assigneeId])
  @@index([assigneeId, status])
  @@index([assignedAt])
}

model SubTask {
  id     Int  @id @default(autoincrement())
  taskId Int
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  assignees SubTaskAssignee[] // 關聯 SubTaskAssignee

  title       String
  status      Status  @default(OPEN)
  priority    Int     @default(3)
  description String?
  location    String?

  // 時間欄位（關鍵）
  // 1) 一般事件/截止時間 -> 存 UTC
  dueAtUtc        DateTime? @db.Timestamptz(6)// 以 UTC 儲存的絕對時間點（nullable）
  // 2) All-day 事件 -> 用當地的「日期」表示
  allDay          Boolean   @default(true)
  allDayLocalDate DateTime? @db.Date // 僅日期；若 allDay=true，則這欄必有值
  // 3) 來源時區（輸入時的時區），IANA
  sourceTimeZone  String?   @db.VarChar(64)

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  closedAt   DateTime?
  closedById Int?
  closedBy   User?     @relation("SubTaskClosedBy", fields: [closedById], references: [id])

  @@index([taskId, status, priority])
}

model SubTaskAssignee {
  subTaskId    Int
  assigneeId   Int
  assignedById Int?

  status AssignmentStatus @default(PENDING)
  reason String?

  assignedAt  DateTime  @default(now())
  acceptedAt  DateTime? @db.Timestamptz(6)
  declinedAt  DateTime? @db.Timestamptz(6)
  completedAt DateTime? @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(6)

  subtask SubTask @relation(fields: [subTaskId], references: [id], onDelete: Cascade)

  assignee   User  @relation("SubTaskAssigneeUser", fields: [assigneeId], references: [id], onDelete: Cascade)
  assignedBy User? @relation("SubTaskAssignedByUser", fields: [assignedById], references: [id], onDelete: SetNull)

  @@id([subTaskId, assigneeId])
  @@index([assigneeId, status])
}
